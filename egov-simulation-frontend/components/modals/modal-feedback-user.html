<!-- 
    COMPONENT: FEEDBACK USER MODAL
    ID: #feedbackUserModal
    Location: components/modals/modal-feedback-user.html
    Usage: Included in Portal Pages. Triggered after finishing a service or via toolbar.
-->
<div class="modal fade" id="feedbackUserModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">

            <!-- HEADER -->
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold text-primary">
                    <i class="bi bi-chat-heart me-2"></i>Đánh giá chất lượng dịch vụ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- BODY -->
            <div class="modal-body">
                <form id="feedbackForm">

                    <!-- STAR RATING -->
                    <div class="text-center mb-3">
                        <p class="mb-2 text-muted small">Bạn hài lòng với dịch vụ này chứ?</p>
                        <div class="rating fs-1 text-warning pointer-event" style="cursor: pointer;">
                            <i class="bi bi-star" data-value="1" onclick="setRating(1)"></i>
                            <i class="bi bi-star" data-value="2" onclick="setRating(2)"></i>
                            <i class="bi bi-star" data-value="3" onclick="setRating(3)"></i>
                            <i class="bi bi-star" data-value="4" onclick="setRating(4)"></i>
                            <i class="bi bi-star" data-value="5" onclick="setRating(5)"></i>
                        </div>
                        <input type="hidden" name="rating" id="ratingValue" value="0">
                        <div id="ratingError" class="text-danger small mt-1 d-none">Vui lòng chọn mức độ đánh giá!</div>
                    </div>

                    <!-- REASON INPUT -->
                    <div class="mb-3">
                        <label for="feedbackContent" class="form-label fw-bold">Nội dung phản ánh <span
                                class="text-danger d-none" id="reasonRequired">*</span></label>
                        <textarea class="form-control" id="feedbackContent" rows="3"
                            placeholder="Nhập ý kiến đóng góp hoặc phàn nàn của bạn..."></textarea>
                        <div id="reasonError" class="text-danger small mt-1 d-none">Vui lòng nhập lý do (vì đánh giá
                            thấp).</div>
                    </div>

                    <!-- EVIDENCE UPLOAD -->
                    <div class="mb-3">
                        <label for="feedbackFile" class="form-label small text-muted">Đính kèm ảnh/video bằng chứng (nếu
                            có)</label>
                        <input class="form-control form-control-sm" type="file" id="feedbackFile"
                            accept="image/*,video/*">
                    </div>

                </form>
            </div>

            <!-- FOOTER -->
            <div class="modal-footer">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" onclick="submitFeedback()">
                    <i class="bi bi-send me-1"></i>Gửi ý kiến
                </button>
            </div>

        </div>
    </div>
</div>

<!-- JS Logic for Rating -->
<script>
    let currentRating = 0;

    function setRating(n) {
        currentRating = n;
        document.getElementById('ratingValue').value = n;

        // Update UI
        const stars = document.querySelectorAll('#feedbackUserModal .rating i');
        stars.forEach((star, index) => {
            if (index < n) {
                star.classList.remove('bi-star');
                star.classList.add('bi-star-fill');
            } else {
                star.classList.remove('bi-star-fill');
                star.classList.add('bi-star');
            }
        });

        // Toggle Required for Low Rating (<= 2)
        const reasonsReq = document.getElementById('reasonRequired');
        if (n <= 2) {
            reasonsReq.classList.remove('d-none');
        } else {
            reasonsReq.classList.add('d-none');
        }
    }

    function submitFeedback() {
        const content = document.getElementById('feedbackContent').value.trim();
        const ratingError = document.getElementById('ratingError');
        const reasonError = document.getElementById('reasonError');

        // Reset Errors
        ratingError.classList.add('d-none');
        reasonError.classList.add('d-none');

        // Validation
        if (currentRating === 0) {
            ratingError.classList.remove('d-none');
            return;
        }

        if (currentRating <= 2 && content === "") {
            reasonError.classList.remove('d-none');
            document.getElementById('feedbackContent').focus();
            return;
        }

        // Trigger Alert if 1 Star (Mock API Call)
        if (currentRating === 1) {
            console.log("WARN: 1 Star Rating! Triggering Leader Alert...");
            // In real app, call API: POST /api/alerts/leader
            alert("Hệ thống đã ghi nhận phản ánh khẩn cấp này và gửi thông báo tới Lãnh đạo đơn vị.");
        } else {
            alert("Cảm ơn bạn đã đóng góp ý kiến!");
        }

        // Close Modal via Bootstrap Instance (Simulation)
        // const modalEl = document.getElementById('feedbackUserModal');
        // const modal = bootstrap.Modal.getInstance(modalEl);
        // modal.hide();

        // Hard close for prototype
        document.querySelector('#feedbackUserModal .btn-close').click();
    }
</script>