<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Hồ sơ - Admin Core</title>
    <!-- Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <link rel="stylesheet" href="../../assets/css/internal.css">
</head>

<body class="bg-light">

    <!-- WRAPPER -->
    <div class="d-flex" id="wrapper">
        <!-- SIDEBAR -->
        <div class="bg-dark text-white border-end"
            style="width: 260px; min-height: 100vh; position: fixed; top: 0; left: 0; z-index: 1000;">
            <div class="p-3 border-bottom d-flex align-items-center bg-black bg-opacity-25">
                <i class="bi bi-cpu-fill fs-4 me-2 text-info"></i>
                <div class="fw-bold">E-GOV ADMIN CORE</div>
            </div>
            <div class="list-group list-group-flush p-2">
                <small class="text-uppercase fw-bold text-muted px-2 mt-3 mb-1" style="font-size: 0.75rem;">Giám sát &
                    Vận hành</small>
                <a href="admin-dashboard.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-speedometer2 me-2"></i>Tổng quan</a>
                <a href="admin-records.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-file-earmark-text me-2"></i>Hồ sơ DVC</a>
                <a href="admin-feedbacks.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-chat-square-quote me-2"></i>Phản ánh & KN</a>
                <a href="admin-audit-logs.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-activity me-2"></i>Audit Logs</a>
                <a href="admin-payment-history.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-currency-exchange me-2"></i>Thanh toán</a>

                <small class="text-uppercase fw-bold text-muted px-2 mt-3 mb-1" style="font-size: 0.75rem;">Quản trị Dữ
                    liệu</small>
                <a href="admin-users.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-people-fill me-2"></i>Người dùng</a>
                <a href="admin-depts.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-diagram-3 me-2"></i>Cơ cấu tổ chức</a>
                <a href="admin-kb-mgmt.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-book me-2"></i>Kho tri thức</a>
                <a href="admin-mock-console.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-database-fill-gear me-2"></i>Mock Console</a>

                <small class="text-uppercase fw-bold text-muted px-2 mt-3 mb-1" style="font-size: 0.75rem;">Cấu hình Hệ
                    thống</small>
                <a href="admin-services.html"
                    class="list-group-item list-group-item-action active bg-secondary bg-opacity-25 text-white border-0 fw-bold"><i
                        class="bi bi-list-check me-2"></i>Dịch vụ công</a>
                <a href="admin-workflow.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-diagram-2 me-2"></i>Quy trình (Workflow)</a>
                <a href="admin-templates.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-file-earmark-word me-2"></i>Biểu mẫu & Phôi</a>
                <a href="admin-system-settings.html"
                    class="list-group-item list-group-item-action bg-transparent text-white-50 border-0"><i
                        class="bi bi-sliders me-2"></i>Tham số hệ thống</a>

                <div class="mt-4 px-2">
                    <a href="../06-shared/internal-login.html" class="btn btn-outline-danger w-100 btn-sm"><i
                            class="bi bi-box-arrow-left me-2"></i>Đăng xuất</a>
                </div>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div style="margin-left: 260px; width: calc(100% - 260px);" class="d-flex flex-column min-vh-100">

            <!-- HEADER -->
            <main class="flex-grow-1 p-4">

                <div class="row h-100">
                    <!-- LIST SECTION -->
                    <div class="col-lg-7 d-flex flex-column">
                        <!-- Toolbar -->
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body py-3">
                                <div class="row g-2 align-items-center">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text bg-white border-end-0"><i
                                                    class="bi bi-search text-muted"></i></span>
                                            <input type="text" class="form-control border-start-0 ps-0" id="searchInput"
                                                placeholder="Tìm kiếm dịch vụ, mã thủ tục...">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <select class="form-select" id="filterSector">
                                            <option value="">Tất cả Lĩnh vực</option>
                                            <option value="Hộ tịch">Hộ tịch</option>
                                            <option value="Đất đai">Đất đai</option>
                                            <option value="Xây dựng">Xây dựng</option>
                                            <option value="Doanh nghiệp">Doanh nghiệp</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3 text-end">
                                        <button class="btn btn-primary w-100 fw-bold" data-bs-toggle="modal"
                                            data-bs-target="#addServiceModal">
                                            <i class="bi bi-plus-lg me-1"></i>Thêm mới
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Table -->
                        <div class="card border-0 shadow-sm flex-grow-1">
                            <div class="card-header bg-white py-3 fw-bold border-bottom">
                                <i class="bi bi-list-task me-2 text-primary"></i>Danh mục Thủ tục hành chính
                            </div>
                            <div class="table-responsive flex-grow-1" style="max-height: 600px; overflow-y: auto;">
                                <table class="table table-hover align-middle mb-0" id="servicesTable">
                                    <thead class="bg-light sticky-top" style="z-index: 5;">
                                        <tr>
                                            <th style="width: 80px;">Mã</th>
                                            <th>Tên Thủ tục</th>
                                            <th style="width: 120px;">Lĩnh vực</th>
                                            <th style="width: 100px;">SLA</th>
                                            <th style="width: 100px;">Trạng thái</th>
                                            <th style="width: 50px;"></th>
                                        </tr>
                                    </thead>
                                    <tbody id="servicesTableBody">
                                        <!-- Render by JS -->
                                    </tbody>
                                </table>
                            </div>
                            <div
                                class="card-footer bg-white border-top py-2 d-flex justify-content-between align-items-center small text-muted">
                                <span id="recordCount">Hiển thị 0 bản ghi</span>
                                <nav>
                                    <ul class="pagination pagination-sm mb-0">
                                        <li class="page-item disabled"><a class="page-link" href="#">Trước</a></li>
                                        <li class="page-item active"><a class="page-link" href="#">1</a></li>
                                        <li class="page-item"><a class="page-link" href="#">2</a></li>
                                        <li class="page-item"><a class="page-link" href="#">Sau</a></li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>

                    <!-- CONFIG SECTION -->
                    <div class="col-lg-5">
                        <div class="card border-0 shadow-sm h-100" id="configPanel">
                            <!-- Empty State -->
                            <div id="emptyState"
                                class="card-body d-flex flex-column align-items-center justify-content-center text-center h-100 text-muted opacity-50">
                                <i class="bi bi-arrow-left-square fs-1 mb-3"></i>
                                <h5>Chưa chọn Dịch vụ</h5>
                                <p>Vui lòng chọn một dịch vụ từ danh sách bên trái để xem chi tiết và cấu hình.</p>
                            </div>

                            <!-- Edit Form -->
                            <div id="editForm" class="d-none h-100 d-flex flex-column">
                                <div
                                    class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
                                    <span id="configTitle">Cấu hình: ...</span>
                                    <span class="badge bg-white text-primary" id="configCode">CODE</span>
                                </div>
                                <div class="card-body overflow-auto">
                                    <form id="serviceForm">
                                        <h6 class="fw-bold text-uppercase text-secondary mb-3 small">Thông tin chung
                                        </h6>
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Tên hiển thị</label>
                                            <input type="text" class="form-control" id="inpName">
                                        </div>
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <label class="form-label small fw-bold">Lĩnh vực</label>
                                                <select class="form-select" id="inpSector">
                                                    <option value="Hộ tịch">Hộ tịch</option>
                                                    <option value="Đất đai">Đất đai</option>
                                                    <option value="Xây dựng">Xây dựng</option>
                                                    <option value="Doanh nghiệp">Doanh nghiệp</option>
                                                    <option value="Lao động">Lao động</option>
                                                </select>
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small fw-bold">Trạng thái</label>
                                                <select class="form-select" id="inpStatus">
                                                    <option value="active" class="text-success fw-bold">Hoạt động
                                                    </option>
                                                    <option value="inactive" class="text-danger fw-bold">Tạm ngưng
                                                    </option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row g-2 mb-3">
                                            <div class="col-6">
                                                <label class="form-label small fw-bold">SLA (Giờ)</label>
                                                <input type="number" class="form-control" id="inpSLA">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label small fw-bold">Lệ phí (VNĐ)</label>
                                                <input type="number" class="form-control" id="inpFee">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Mô tả ngắn</label>
                                            <textarea class="form-control" rows="2" id="inpDesc"></textarea>
                                        </div>

                                        <hr class="border-secondary border-opacity-10">

                                        <h6 class="fw-bold text-uppercase text-secondary mb-3 small">Thiết lập Quy trình
                                            & Biểu mẫu</h6>

                                        <div class="mb-3">
                                            <label class="form-label small fw-bold">Mẫu in kết quả</label>
                                            <select class="form-select">
                                                <option selected>mau_khai_sinh_2024.docx</option>
                                                <option>mau_chung.docx</option>
                                                <option>mau_cap_phep_xd.docx</option>
                                            </select>
                                        </div>

                                        <div class="row g-2 mb-3">
                                            <div class="col-md-6">
                                                <button type="button"
                                                    class="btn btn-outline-secondary w-100 text-start btn-sm"
                                                    data-bs-toggle="modal" data-bs-target="#formBuilderModal">
                                                    <i class="bi bi-window-stack me-2"></i>E-Form Layout
                                                </button>
                                            </div>
                                            <div class="col-md-6">
                                                <button type="button"
                                                    class="btn btn-outline-secondary w-100 text-start btn-sm">
                                                    <i class="bi bi-diagram-3 me-2"></i>Workflow
                                                </button>
                                            </div>
                                        </div>

                                        <div
                                            class="alert alert-success small mb-0 py-2 px-3 border-0 bg-success bg-opacity-10 text-success">
                                            <i class="bi bi-check-circle-fill me-1"></i>Dữ liệu đã được ánh xạ Schema
                                            v2.0
                                        </div>
                                    </form>
                                </div>
                                <div class="card-footer bg-white py-3 border-top">
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary flex-grow-1 fw-bold" onclick="saveChanges()">
                                            <i class="bi bi-save me-1"></i>Lưu thay đổi
                                        </button>
                                        <button class="btn btn-light border text-danger" onclick="closeConfig()">
                                            Huỷ
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Modals Container -->
    <div id="modalContainer"></div>

    <!-- ADD NEW MODAL -->
    <div class="modal fade" id="addServiceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold">Thêm mới Dịch vụ công</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addForm">
                        <div class="mb-3">
                            <label class="form-label">Mã thủ tục <span class="text-danger">*</span></label>
                            <input type="text" class="form-control font-monospace text-uppercase" required
                                placeholder="VD: TTHC-001">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tên thủ tục <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" required>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label class="form-label">Lĩnh vực</label>
                                <select class="form-select">
                                    <option value="Hộ tịch">Hộ tịch</option>
                                    <option value="Đất đai">Đất đai</option>
                                </select>
                            </div>
                            <div class="col-6">
                                <label class="form-label">SLA (Giờ)</label>
                                <input type="number" class="form-control" value="8">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="button" class="btn btn-primary" onclick="addNewService()">Thêm mới</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // MOCK DATA
        let servicesData = [
            { id: 1, code: 'KS01', name: 'Đăng ký khai sinh', sector: 'Hộ tịch', sla: 4, fee: 50000, status: 'active', desc: 'Thủ tục đăng ký khai sinh cho trẻ em mới sinh.' },
            { id: 2, code: 'KH02', name: 'Đăng ký kết hôn', sector: 'Hộ tịch', sla: 24, fee: 200000, status: 'active', desc: 'Thủ tục đăng ký kết hôn tại UBND xã/phường.' },
            { id: 3, code: 'QSD03', name: 'Cấp Giấy chứng nhận QSDĐ', sector: 'Đất đai', sla: 120, fee: 500000, status: 'active', desc: 'Cấp mới sổ đỏ cho hộ gia đình/cá nhân.' },
            { id: 4, code: 'XD04', name: 'Cấp giấy phép xây dựng nhà ở', sector: 'Xây dựng', sla: 72, fee: 300000, status: 'active', desc: 'Thủ tục cấp phép xây dựng nhà ở riêng lẻ.' },
            { id: 5, code: 'DN05', name: 'Đăng ký kinh doanh hộ cá thể', sector: 'Doanh nghiệp', sla: 8, fee: 100000, status: 'inactive', desc: 'Đăng ký hộ kinh doanh cá thể quy mô nhỏ.' },
            { id: 6, code: 'TT06', name: 'Xác nhận tình trạng hôn nhân', sector: 'Hộ tịch', sla: 4, fee: 20000, status: 'active', desc: '' },
            { id: 7, code: 'DB07', name: 'Đăng ký biến động đất đai', sector: 'Đất đai', sla: 48, fee: 150000, status: 'active', desc: 'Sang tên, đổi chủ, tặng cho quyền sử dụng đất.' }
        ];

        let currentId = null;

        // INIT
        document.addEventListener('DOMContentLoaded', () => {
            // Load component modal form builder (fake)
            fetch('../../components/modals/modal-form-builder.html')
                .then(r => {
                    if (r.ok) return r.text();
                    return ''; // Fail silently
                })
                .then(html => {
                    if (html) document.getElementById('modalContainer').innerHTML = html;
                });

            renderTable(servicesData);

            // Filter Handlers
            document.getElementById('searchInput').addEventListener('input', handleFilter);
            document.getElementById('filterSector').addEventListener('change', handleFilter);
        });

        function handleFilter() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const sector = document.getElementById('filterSector').value;

            const filtered = servicesData.filter(s => {
                const matchName = s.name.toLowerCase().includes(term) || s.code.toLowerCase().includes(term);
                const matchSector = sector === '' || s.sector === sector;
                return matchName && matchSector;
            });
            renderTable(filtered);
        }

        function renderTable(data) {
            const tbody = document.getElementById('servicesTableBody');
            const countLabel = document.getElementById('recordCount');

            tbody.innerHTML = '';
            countLabel.innerText = `Hiển thị ${data.length} bản ghi`;

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-muted">Không tìm thấy dữ liệu</td></tr>`;
                return;
            }

            data.forEach(item => {
                const tr = document.createElement('tr');
                if (currentId === item.id) tr.classList.add('table-active');
                tr.style.cursor = 'pointer';
                tr.onclick = () => selectService(item.id);

                const statusBadge = item.status === 'active'
                    ? '<span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25">Hoạt động</span>'
                    : '<span class="badge bg-secondary text-white-50">Tạm ngưng</span>';

                tr.innerHTML = `
                    <td class="font-monospace fw-bold text-primary small">${item.code}</td>
                    <td class="fw-bold text-dark">${item.name}</td>
                    <td><span class="badge bg-light text-dark border">${item.sector}</span></td>
                    <td class="small text-muted">${item.sla}h</td>
                    <td>${statusBadge}</td>
                    <td><i class="bi bi-chevron-right text-muted small"></i></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function selectService(id) {
            currentId = id;
            handleFilter(); // Re-render to update active row highlight

            const sv = servicesData.find(s => s.id === id);

            // Show Form, Hide Empty
            document.getElementById('emptyState').classList.add('d-none');
            const formContainer = document.getElementById('editForm');
            formContainer.classList.remove('d-none');

            // Bind Data
            document.getElementById('configTitle').innerText = 'Cấu hình: ' + sv.name;
            document.getElementById('configCode').innerText = sv.code;

            document.getElementById('inpName').value = sv.name;
            document.getElementById('inpSector').value = sv.sector;
            document.getElementById('inpStatus').value = sv.status;
            document.getElementById('inpSLA').value = sv.sla;
            document.getElementById('inpFee').value = sv.fee;
            document.getElementById('inpDesc').value = sv.desc || '';
        }

        function closeConfig() {
            currentId = null;
            document.getElementById('emptyState').classList.remove('d-none');
            document.getElementById('editForm').classList.add('d-none');
            handleFilter();
        }

        function saveChanges() {
            if (!currentId) return;
            const sv = servicesData.find(s => s.id === currentId);

            // Save logic (mock)
            sv.name = document.getElementById('inpName').value;
            sv.sector = document.getElementById('inpSector').value;
            sv.status = document.getElementById('inpStatus').value;
            sv.sla = document.getElementById('inpSLA').value;
            sv.fee = document.getElementById('inpFee').value;
            sv.desc = document.getElementById('inpDesc').value;

            // Toast feedback
            alert(`Đã lưu cấu hình dịch vụ [${sv.code}] thành công!`);
            handleFilter(); // Updates table display
        }

        function addNewService() {
            // Very simple Mock Add
            const newId = servicesData.length > 0 ? Math.max(...servicesData.map(s => s.id)) + 1 : 1;
            const inputs = document.querySelector('#addForm').querySelectorAll('input, select');

            const newSv = {
                id: newId,
                code: inputs[0].value,
                name: inputs[1].value,
                sector: inputs[2].value,
                sla: inputs[3].value,
                fee: 0,
                status: 'active',
                desc: ''
            };

            servicesData.unshift(newSv);
            handleFilter();

            // Hide Modal manual way (or bootstrap way)
            const modalEl = document.getElementById('addServiceModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            modal.hide();

            // Auto Select
            selectService(newId);
        }
    </script>
</body>

</html>