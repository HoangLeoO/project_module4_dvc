# ğŸš€ HÆ¯á»šNG DáºªN Cáº¢I TIáº¾N TRá»¢ LÃ áº¢O LUYá»†N NÃ“I TIáº¾NG ANH

## ğŸ“‹ Má»¥c lá»¥c
1. [Tá»•ng quan cÃ¡c váº¥n Ä‘á»](#tá»•ng-quan-cÃ¡c-váº¥n-Ä‘á»)
2. [Giáº£i phÃ¡p chi tiáº¿t](#giáº£i-phÃ¡p-chi-tiáº¿t)
3. [Code hoÃ n chá»‰nh Ä‘Ã£ sá»­a](#code-hoÃ n-chá»‰nh-Ä‘Ã£-sá»­a)
4. [HÆ°á»›ng dáº«n cÃ i Ä‘áº·t](#hÆ°á»›ng-dáº«n-cÃ i-Ä‘áº·t)
5. [HÆ°á»›ng dáº«n sá»­ dá»¥ng](#hÆ°á»›ng-dáº«n-sá»­-dá»¥ng)

---

## ğŸ”´ Tá»•ng quan cÃ¡c váº¥n Ä‘á»

### Váº¥n Ä‘á» 1: Kiá»ƒm tra ngá»¯ phÃ¡p/chÃ­nh táº£ chÆ°a tá»‘t
- **Hiá»‡n táº¡i:** Sá»­ dá»¥ng TextBlob - kháº£ nÄƒng phÃ¡t hiá»‡n lá»—i háº¡n cháº¿
- **Váº¥n Ä‘á»:** Muá»‘n má»Ÿ rá»™ng nhÆ°ng sá»£ tá»‘n phÃ­ (API tráº£ phÃ­ nhÆ° Grammarly, ChatGPT)
- **áº¢nh hÆ°á»Ÿng:** Feedback khÃ´ng chÃ­nh xÃ¡c, ngÆ°á»i dÃ¹ng khÃ´ng biáº¿t mÃ¬nh sai á»Ÿ Ä‘Ã¢u

### Váº¥n Ä‘á» 2: Thá»i gian nghe quÃ¡ nhanh
- **Hiá»‡n táº¡i:** `phrase_time_limit=30` giÃ¢y - cáº¯t ngay sau 30s
- **Váº¥n Ä‘á»:** NgÆ°á»i dÃ¹ng chÆ°a nÃ³i háº¿t cÃ¢u Ä‘Ã£ bá»‹ cáº¯t
- **áº¢nh hÆ°á»Ÿng:** Tráº£i nghiá»‡m tá»‡, khÃ´ng luyá»‡n Ä‘Æ°á»£c cÃ¢u dÃ i

### Váº¥n Ä‘á» 3: Feedback hiá»ƒn thá»‹ quÃ¡ nhanh
- **Hiá»‡n táº¡i:** Robot nÃ³i xong feedback â†’ há»i tiáº¿p ngay
- **Váº¥n Ä‘á»:** NgÆ°á»i dÃ¹ng khÃ´ng ká»‹p Ä‘á»c pháº£n há»“i trÃªn mÃ n hÃ¬nh
- **áº¢nh hÆ°á»Ÿng:** KhÃ´ng há»c Ä‘Æ°á»£c tá»« lá»—i sai

---

## âœ… Giáº£i phÃ¡p chi tiáº¿t

### ğŸ¯ Giáº£i phÃ¡p 1: NÃ¢ng cáº¥p kiá»ƒm tra ngá»¯ phÃ¡p vá»›i LanguageTool (MIá»„N PHÃ)

#### Táº¡i sao chá»n LanguageTool? 
- âœ… **HoÃ n toÃ n miá»…n phÃ­** - KhÃ´ng cáº§n API key, khÃ´ng giá»›i háº¡n
- âœ… **Máº¡nh hÆ¡n TextBlob** - PhÃ¡t hiá»‡n lá»—i ngá»¯ phÃ¡p phá»©c táº¡p, dáº¥u cÃ¢u, cáº¥u trÃºc cÃ¢u
- âœ… **Há»— trá»£ offline** - KhÃ´ng phá»¥ thuá»™c internet (sau khi cÃ i)
- âœ… **Gá»£i Ã½ sá»­a lá»—i cá»¥ thá»ƒ** - KhÃ´ng chá»‰ nÃ³i "sai" mÃ  cÃ²n chá»‰ ra sá»­a tháº¿ nÃ o

#### So sÃ¡nh TextBlob vs LanguageTool

| TiÃªu chÃ­ | TextBlob | LanguageTool |
|----------|----------|--------------|
| Miá»…n phÃ­ | âœ… | âœ… |
| PhÃ¡t hiá»‡n lá»—i chÃ­nh táº£ | âœ… | âœ… |
| PhÃ¡t hiá»‡n lá»—i ngá»¯ phÃ¡p | âš ï¸ CÆ¡ báº£n | âœ… NÃ¢ng cao |
| Gá»£i Ã½ sá»­a lá»—i | âš ï¸ ÄÆ¡n giáº£n | âœ… Chi tiáº¿t |
| Kiá»ƒm tra dáº¥u cÃ¢u | âŒ | âœ… |
| Kiá»ƒm tra cáº¥u trÃºc cÃ¢u | âŒ | âœ… |

#### Code so sÃ¡nh

**TRÆ¯á»šC (TextBlob):**
```python
from textblob import TextBlob

def generate_feedback(user_text):
    blob = TextBlob(user_text)
    corrected_text = str(blob.correct())
    
    if user_text != corrected_text:
        return "Some potential mistakes detected."
    else:
        return "Good!"
```

**SAU (LanguageTool):**
```python
import language_tool_python

# Khá»Ÿi táº¡o 1 láº§n á»Ÿ Ä‘áº§u file
tool = language_tool_python.LanguageTool('en-US')

def generate_feedback_improved(user_text):
    """PhiÃªn báº£n cáº£i tiáº¿n vá»›i LanguageTool"""
    if not user_text or user_text in ["TIMEOUT", "UNKNOWN_VALUE", "REQUEST_ERROR", "UNEXPECTED_ERROR"]:
        return "Could not recognize your answer.  Please speak more clearly."
    
    # Kiá»ƒm tra Ä‘á»™ dÃ i
    word_count = len(user_text.split())
    if word_count < 5:
        length_note = "âš ï¸ Your answer is too short. Try to give more details (at least 5-10 words)."
    elif word_count < 10:
        length_note = "âœ… Good length, but try to elaborate more."
    else:
        length_note = "âœ… Excellent!  Your answer has good length."
    
    # Kiá»ƒm tra lá»—i vá»›i LanguageTool
    matches = tool.check(user_text)
    
    if len(matches) == 0:
        grammar_note = "âœ… Perfect! No grammar or spelling errors detected."
        corrected_text = user_text
    else:
        # Tá»± Ä‘á»™ng sá»­a lá»—i
        corrected_text = language_tool_python.utils.correct(user_text, matches)
        
        # Liá»‡t kÃª cÃ¡c lá»—i cá»¥ thá»ƒ
        error_details = []
        for i, match in enumerate(matches[: 3], 1):  # Chá»‰ hiá»ƒn thá»‹ 3 lá»—i Ä‘áº§u
            error_details.append(
                f"   {i}. '{match.context}' â†’ Suggestion: {match.replacements[: 2] if match.replacements else 'Check structure'}"
            )
        
        grammar_note = f"âš ï¸ Found {len(matches)} error(s):\n" + "\n".join(error_details)
        if len(matches) > 3:
            grammar_note += f"\n   ... and {len(matches) - 3} more errors."
    
    # Táº¡o feedback Ä‘áº§y Ä‘á»§ vá»›i Ä‘á»‹nh dáº¡ng dá»… Ä‘á»c
    feedback = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          ğŸ“Š FEEDBACK                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ¤ Your speech recognized:                                        â•‘
â•‘    "{user_text}"
â•‘                                                                   â•‘
â•‘ âœï¸ Suggested correction:                                         â•‘
â•‘    "{corrected_text}"
â•‘                                                                   â•‘
â•‘ ğŸ“ Length Analysis:                                              â•‘
â•‘    {length_note}
â•‘                                                                   â•‘
â•‘ ğŸ“ Grammar & Spelling:                                           â•‘
â•‘    {grammar_note}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Please take your time to read this feedback.  Say "continue" when ready.
"""
    return feedback
```

---

### ğŸ¯ Giáº£i phÃ¡p 2: Sá»­a thá»i gian nghe quÃ¡ nhanh

#### Váº¥n Ä‘á» cá»¥ thá»ƒ

**Trong file `banchaythu.py` dÃ²ng 111-115:**
```python
# âŒ Váº¤N Äá»€: 
audio = robot_ear.listen(mic, timeout=timeout_seconds, phrase_time_limit=phrase_timeout)
# phrase_time_limit=30 â†’ CHá»ˆ NGHE Tá»I ÄA 30 GIÃ‚Y, SAU ÄÃ“ Cáº®T! 
```

**Táº¡i dÃ²ng 195:**
```python
# âŒ Váº¤N Äá»€:
user_answer = listen_with_timeout(source, timeout_seconds=90, phrase_timeout=30)
# NgÆ°á»i dÃ¹ng chá»‰ cÃ³ 30 giÃ¢y Ä‘á»ƒ nÃ³i â†’ QuÃ¡ ngáº¯n!
```

#### Giáº£i phÃ¡p chi tiáº¿t

**Thay Ä‘á»•i 1: Äiá»u chá»‰nh ngÆ°á»¡ng im láº·ng (pause_threshold)**

```python
# Máº·c Ä‘á»‹nh cá»§a SpeechRecognition: 
robot_ear.pause_threshold = 0.8  # Im láº·ng 0.8s â†’ Káº¿t thÃºc (quÃ¡ nhanh!)

# NÃªn tÄƒng lÃªn:
robot_ear.pause_threshold = 3.0  # Im láº·ng 3s â†’ Káº¿t thÃºc (vá»«a pháº£i)
```

**Thay Ä‘á»•i 2: Bá» giá»›i háº¡n thá»i gian nÃ³i (phrase_time_limit)**

```python
# TRÆ¯á»šC: 
audio = robot_ear.listen(mic, timeout=90, phrase_time_limit=30)
# â†’ Tá»‘i Ä‘a 30 giÃ¢y

# SAU:
audio = robot_ear.listen(mic, timeout=15, phrase_time_limit=None)
# â†’ KHÃ”NG GIá»šI Háº N thá»i gian nÃ³i, chá»‰ cáº§n khÃ´ng im láº·ng quÃ¡ lÃ¢u
```

#### Code cáº£i tiáº¿n Ä‘áº§y Ä‘á»§

```python
def listen_with_timeout_improved(mic, timeout_seconds=15, phrase_timeout=None, pause_threshold=3.0):
    """
    Cáº£i tiáº¿n chá»©c nÄƒng nghe: 
    
    Args:
        mic: Microphone object
        timeout_seconds:  Thá»i gian chá» ngÆ°á»i dÃ¹ng Báº®T Äáº¦U nÃ³i (máº·c Ä‘á»‹nh 15s)
        phrase_timeout: Thá»i gian Tá»I ÄA cho 1 cÃ¢u nÃ³i (None = khÃ´ng giá»›i háº¡n)
        pause_threshold: Thá»i gian im láº·ng Ä‘á»ƒ Káº¾T THÃšC ghi Ã¢m (máº·c Ä‘á»‹nh 3s)
    
    Returns:
        str: Text Ä‘Æ°á»£c nháº­n diá»‡n hoáº·c error code
    """
    print("User: *Listening...  (Speak freely, I'll wait for you to finish)*")
    
    # â­ QUAN TRá»ŒNG: Äiá»u chá»‰nh ngÆ°á»¡ng im láº·ng
    robot_ear.pause_threshold = pause_threshold  
    robot_ear.non_speaking_duration = 0.5  
    
    try:
        # Bá» phrase_time_limit Ä‘á»ƒ khÃ´ng giá»›i háº¡n thá»i gian nÃ³i
        audio = robot_ear.listen(mic, timeout=timeout_seconds, phrase_time_limit=phrase_timeout)
        
        print("User: *Processing your speech...*")
        user_text = robot_ear.recognize_google(audio, language="en-US")
        print(f"âœ… User recognized: {user_text}")
        return user_text
        
    except sr.WaitTimeoutError:
        print("â±ï¸ Timed out waiting for speech (no sound detected).")
        return "TIMEOUT" 
    except sr.UnknownValueError:
        print("âŒ Could not understand audio clearly.")
        return "UNKNOWN_VALUE"
    except sr.RequestError as e:
        print(f"ğŸŒ Error:  Could not connect to Google API; {e}")
        return "REQUEST_ERROR"
    except Exception as e:
        print(f"âš ï¸ Unexpected error:  {e}")
        return "UNEXPECTED_ERROR"
```

#### CÃ¡ch sá»­ dá»¥ng trong main()

```python
# TRÆ¯á»šC (dÃ²ng 195):
user_answer = listen_with_timeout(source, timeout_seconds=90, phrase_timeout=30)

# SAU - Thay báº±ng: 
user_answer = listen_with_timeout_improved(
    source, 
    timeout_seconds=15,      # Chá» 15s Ä‘á»ƒ báº¯t Ä‘áº§u nÃ³i
    phrase_timeout=None,     # KHÃ”NG giá»›i háº¡n Ä‘á»™ dÃ i cÃ¢u
    pause_threshold=3.0      # Im láº·ng 3 giÃ¢y â†’ Káº¿t thÃºc ghi Ã¢m
)
```

#### Giáº£i thÃ­ch cÃ¡c tham sá»‘

| Tham sá»‘ | Ã nghÄ©a | GiÃ¡ trá»‹ Ä‘á» xuáº¥t |
|---------|---------|-----------------|
| `timeout_seconds` | Thá»i gian chá» ngÆ°á»i dÃ¹ng **báº¯t Ä‘áº§u** nÃ³i | 15 giÃ¢y |
| `phrase_timeout` | Thá»i gian **tá»‘i Ä‘a** cho 1 cÃ¢u nÃ³i | `None` (khÃ´ng giá»›i háº¡n) |
| `pause_threshold` | Thá»i gian **im láº·ng** Ä‘á»ƒ káº¿t thÃºc | 3.0 giÃ¢y |

**VÃ­ dá»¥ thá»±c táº¿:**
```
Robot: "Describe your family."
[NgÆ°á»i dÃ¹ng cÃ³ 15 giÃ¢y Ä‘á»ƒ báº¯t Ä‘áº§u nÃ³i]

User: "My family has four members...  [im láº·ng 1s] ...  my father is a teacher... [im láº·ng 1s] ... and my mother..."
[CÃ³ thá»ƒ nÃ³i bao lÃ¢u cÅ©ng Ä‘Æ°á»£c, chá»‰ cáº§n khÃ´ng im láº·ng quÃ¡ 3 giÃ¢y]

[Im láº·ng 3 giÃ¢y]
â†’ Robot tá»± Ä‘á»™ng káº¿t thÃºc ghi Ã¢m vÃ  xá»­ lÃ½
```

---

### ğŸ¯ Giáº£i phÃ¡p 3: Cáº£i thiá»‡n feedback (ngÆ°á»i dÃ¹ng ká»‹p Ä‘á»c)

#### Váº¥n Ä‘á» hiá»‡n táº¡i

```python
# DÃ²ng 204-207 trong banchaythu.py:
feedback = generate_feedback(user_answer)
speak_and_print(feedback)  # âŒ NÃ³i xong

speak_and_print("Do you want to continue... ?")  # âŒ Há»i liá»n, khÃ´ng chá» Ä‘á»c! 
```

#### Giáº£i phÃ¡p:  ThÃªm xÃ¡c nháº­n "ÄÃ£ Ä‘á»c xong"

**Code cáº£i tiáº¿n:**

```python
# Sau khi Ä‘Æ°a feedback (thay tháº¿ dÃ²ng 204-207):

feedback = generate_feedback_improved(user_answer)
speak_and_print(feedback)

# â­ THÃŠM PHáº¦N NÃ€Y:
print("\n" + "="*70)
print("â³ Take your time to read the feedback above...")
print("="*70)

# Chá» ngÆ°á»i dÃ¹ng Ä‘á»c xong
speak_and_print("Have you finished reading the feedback?  Say 'yes' or 'continue'.")
time.sleep(2)  # Cho thá»i gian nghÄ©

confirmation = listen_with_timeout_improved(
    source, 
    timeout_seconds=30,      # Chá» 30s
    pause_threshold=2.0      # Im láº·ng 2s lÃ  Ä‘á»§
).lower()

# Kiá»ƒm tra xÃ¡c nháº­n
if any(word in confirmation for word in ["yes", "yeah", "ok", "continue", "ready"]):
    speak_and_print("Great! Let's move on.")
else:
    speak_and_print("Take your time.  Say 'ready' when you want to continue.")
    # Chá» thÃªm 1 láº§n ná»¯a
    time.sleep(3)
    listen_with_timeout_improved(source, timeout_seconds=60, pause_threshold=2.0)

# Sau Ä‘Ã³ má»›i há»i tiáº¿p
speak_and_print("Do you want to continue this unit, change to another unit, or say 'bye'?")
```

#### Giáº£i phÃ¡p bá»• sung: TÄƒng thá»i gian hiá»ƒn thá»‹

```python
def speak_and_print_with_pause(text, pause_seconds=3):
    """
    NÃ³i vÃ  in ra mÃ n hÃ¬nh, sau Ä‘Ã³ dá»«ng 1 khoáº£ng thá»i gian
    Ä‘á»ƒ ngÆ°á»i dÃ¹ng cÃ³ thá»i gian Ä‘á»c
    """
    print("Robot: " + text)
    robot_mouth.say(text)
    robot_mouth.runAndWait()
    
    # Dá»«ng thÃªm thá»i gian Ä‘á»ƒ Ä‘á»c
    if pause_seconds > 0:
        print(f"[Pausing for {pause_seconds} seconds to let you read...]")
        time.sleep(pause_seconds)
```

---

### ğŸ¯ Giáº£i phÃ¡p 4: Äiá»u chá»‰nh tá»‘c Ä‘á»™ nÃ³i cá»§a robot

#### Váº¥n Ä‘á» hiá»‡n táº¡i

```python
# DÃ²ng 8-10 trong banchaythu.py:
robot_mouth = pyttsx3.init()
# KhÃ´ng cÃ³ cáº¥u hÃ¬nh â†’ Tá»‘c Ä‘á»™ máº·c Ä‘á»‹nh (thÆ°á»ng ~200 tá»«/phÃºt - hÆ¡i nhanh)
```

#### Code cáº£i tiáº¿n

```python
# Khá»Ÿi táº¡o vÃ  cáº¥u hÃ¬nh robot nÃ³i (thay tháº¿ dÃ²ng 8-10)
robot_mouth = pyttsx3.init()

try:
    # â­ Giáº£m tá»‘c Ä‘á»™ nÃ³i
    robot_mouth.setProperty('rate', 140)  # Tá»« 150-200 â†’ 140 (cháº­m hÆ¡n, dá»… nghe)
    
    # â­ TÄƒng Ã¢m lÆ°á»£ng
    robot_mouth.setProperty('volume', 1.0)  # Tá»‘i Ä‘a (0.0 - 1.0)
    
    # â­ (Tuá»³ chá»n) Äá»•i giá»ng nÃ³i
    voices = robot_mouth.getProperty('voices')
    # voices[0] = giá»ng nam (máº·c Ä‘á»‹nh)
    # voices[1] = giá»ng ná»¯ (náº¿u cÃ³)
    robot_mouth.setProperty('voice', voices[0].id)  # Chá»n giá»ng nam
    
except Exception as e:
    print(f"âš ï¸ Warning: Could not configure pyttsx3. Using default settings.  Error: {e}")
```

#### Báº£ng tá»‘c Ä‘á»™ Ä‘á» xuáº¥t

| Tá»‘c Ä‘á»™ (words/min) | ÄÃ¡nh giÃ¡ | PhÃ¹ há»£p |
|-------------------|----------|---------|
| 200+ | QuÃ¡ nhanh | âŒ KhÃ³ nghe |
| 150-180 | BÃ¬nh thÆ°á»ng | âš ï¸ HÆ¡i nhanh vá»›i ngÆ°á»i má»›i |
| 130-150 | Vá»«a pháº£i | âœ… Äá» xuáº¥t |
| < 120 | QuÃ¡ cháº­m | âŒ GÃ¢y nhÃ m chÃ¡n |

---

## ğŸ“¦ Code hoÃ n chá»‰nh Ä‘Ã£ sá»­a

### File:  `banchaythu_fixed.py`

```python
import speech_recognition as sr
import pyttsx3
import time
import language_tool_python  # â­ THAY THáº¾ TextBlob

# --- 1. Khá»Ÿi táº¡o vÃ  Cáº¥u hÃ¬nh (ÄÃƒ Cáº¢I TIáº¾N) ---
robot_ear = sr.Recognizer()
robot_mouth = pyttsx3.init()

# â­ Cáº¥u hÃ¬nh tá»‘c Ä‘á»™ nÃ³i vÃ  Ã¢m lÆ°á»£ng
try:
    robot_mouth.setProperty('rate', 140)  # Giáº£m tá»‘c Ä‘á»™
    robot_mouth.setProperty('volume', 1.0)  # TÄƒng Ã¢m lÆ°á»£ng
except Exception as e:
    print(f"âš ï¸ Warning: Could not set pyttsx3 properties. Error: {e}")

# â­ Khá»Ÿi táº¡o LanguageTool (thay TextBlob)
try:
    tool = language_tool_python.LanguageTool('en-US')
    print("âœ… LanguageTool initialized successfully!")
except Exception as e: 
    print(f"âš ï¸ Warning: Could not initialize LanguageTool. Error: {e}")
    tool = None

# --- 2. Dá»¯ liá»‡u cÃ¡c Unit ---
units = {
    1: ["Introduce yourself.",
        "What do you like to do in your free time?",
        "Describe a typical day in your life. "],
    2: ["Which subject do you like the most and why?",
        "Tell me about one of your hobbies.",
        "What do you want to become in the future?"],
    3: ["Describe your family.",
        "Where have you traveled and what impressed you the most?",
        "Tell me about a happy memory in your life."],
    4: ["What do you think about modern technology?",
        "Explain a simple scientific concept.",
        "How do you use the internet daily?"],
    5: ["Describe your favorite food.",
        "Which sport do you like and why?",
        "Talk about an outdoor activity you enjoy."],
    6: ["What do you think about the environment and protecting it?",
        "Describe a social issue you care about.",
        "Have you participated in any charity activities?"],
    7: ["Describe a book you like.",
        "What kind of music do you enjoy and why?",
        "Talk about a movie that impressed you."],
    8: ["What do you think about health and exercise?",
        "Describe a good habit you have.",
        "What did you learn from a mistake? "],
    9: ["Describe a skill you want to learn.",
        "What do you think about the future of AI?",
        "Summarize what you learned today."]
}

# --- 3. HÃ m Há»— trá»£ (ÄÃƒ Cáº¢I TIáº¾N) ---

def word_to_int(text):
    """Chuyá»ƒn Ä‘á»•i tá»« chá»¯ sang sá»‘"""
    if not text:
        return None
        
    text = text.lower().strip()
    
    word_map = {
        "one": 1, "number one": 1, "unit one": 1, "first": 1,
        "two": 2, "number two": 2, "unit two": 2, "second": 2,
        "three": 3, "number three": 3, "unit three": 3, "third": 3,
        "four": 4, "number four": 4, "unit four": 4,
        "five": 5, "number five": 5, "unit five": 5,
        "six": 6, "number six": 6, "unit six": 6,
        "seven": 7, "number seven": 7, "unit seven": 7,
        "eight": 8, "number eight":  8, "unit eight": 8,
        "nine": 9, "number nine": 9, "unit nine": 9
    }
    
    try:
        if any(char. isdigit() for char in text):
            num_str = "".join(filter(str.isdigit, text))
            if num_str: 
                return int(num_str)
    except ValueError:
        pass 
    
    for word, num in word_map.items():
        if word in text: 
            return num
            
    return None

def generate_feedback_improved(user_text):
    """
    â­ HÃ€M Má»šI: Feedback cáº£i tiáº¿n vá»›i LanguageTool
    """
    if not user_text or user_text in ["TIMEOUT", "UNKNOWN_VALUE", "REQUEST_ERROR", "UNEXPECTED_ERROR"]:
        return "Could not recognize your answer. Please speak more clearly."
    
    # Kiá»ƒm tra Ä‘á»™ dÃ i
    word_count = len(user_text.split())
    if word_count < 5:
        length_note = "âš ï¸ Your answer is too short. Try to give more details (at least 5-10 words)."
    elif word_count < 10:
        length_note = "âœ… Good length, but try to elaborate more."
    else:
        length_note = f"âœ… Excellent! Your answer has {word_count} words."
    
    # Kiá»ƒm tra lá»—i vá»›i LanguageTool
    if tool:
        try:
            matches = tool.check(user_text)
            
            if len(matches) == 0:
                grammar_note = "âœ… Perfect! No grammar or spelling errors detected."
                corrected_text = user_text
            else:
                # Tá»± Ä‘á»™ng sá»­a lá»—i
                corrected_text = language_tool_python.utils.correct(user_text, matches)
                
                # Liá»‡t kÃª cÃ¡c lá»—i cá»¥ thá»ƒ
                error_details = []
                for i, match in enumerate(matches[:3], 1):
                    suggestions = ", ".join(match.replacements[: 2]) if match.replacements else "Check structure"
                    error_details. append(f"   {i}. Error: '{match.context. strip()}' â†’ Try: {suggestions}")
                
                grammar_note = f"âš ï¸ Found {len(matches)} error(s):\n" + "\n".join(error_details)
                if len(matches) > 3:
                    grammar_note += f"\n   ... and {len(matches) - 3} more errors."
        except Exception as e:
            grammar_note = f"âš ï¸ Could not check grammar. Error: {e}"
            corrected_text = user_text
    else:
        grammar_note = "âš ï¸ LanguageTool not available."
        corrected_text = user_text
    
    # Táº¡o feedback vá»›i format Ä‘áº¹p
    feedback = f"""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                          ğŸ“Š FEEDBACK                              â•‘
â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
â•‘ ğŸ¤ Your speech recognized:                                        â•‘
â•‘    "{user_text}"
â•‘                                                                   â•‘
â•‘ âœï¸ Suggested correction:                                         â•‘
â•‘    "{corrected_text}"
â•‘                                                                   â•‘
â•‘ ğŸ“ Length Analysis ({word_count} words):                         â•‘
â•‘    {length_note}
â•‘                                                                   â•‘
â•‘ ğŸ“ Grammar & Spelling:                                           â•‘
{grammar_note}
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    return feedback

def speak_and_print(text):
    """NÃ³i vÃ  in ra mÃ n hÃ¬nh"""
    print("Robot: " + text)
    robot_mouth.say(text)
    robot_mouth.runAndWait()

def listen_with_timeout_improved(mic, timeout_seconds=15, phrase_timeout=None, pause_threshold=3.0):
    """
    â­ HÃ€M Má»šI:  Nghe vá»›i cáº¥u hÃ¬nh tá»‘i Æ°u
    
    Args:
        timeout_seconds: Thá»i gian chá» báº¯t Ä‘áº§u nÃ³i (máº·c Ä‘á»‹nh 15s)
        phrase_timeout: Thá»i gian tá»‘i Ä‘a cho 1 cÃ¢u (None = khÃ´ng giá»›i háº¡n)
        pause_threshold: Thá»i gian im láº·ng Ä‘á»ƒ káº¿t thÃºc (máº·c Ä‘á»‹nh 3s)
    """
    print("User: *Listening...  (Speak freely, I'll wait for you to finish)*")
    
    # â­ Äiá»u chá»‰nh ngÆ°á»¡ng im láº·ng
    robot_ear.pause_threshold = pause_threshold
    robot_ear.non_speaking_duration = 0.5
    
    try:
        audio = robot_ear.listen(mic, timeout=timeout_seconds, phrase_time_limit=phrase_timeout)
        print("User: *Processing your speech.. .*")
        user_text = robot_ear.recognize_google(audio, language="en-US")
        print(f"âœ… User recognized: {user_text}")
        return user_text
        
    except sr.WaitTimeoutError:
        print("â±ï¸ Timed out waiting for speech.")
        return "TIMEOUT" 
    except sr.UnknownValueError:
        print("âŒ Could not understand audio.")
        return "UNKNOWN_VALUE"
    except sr.RequestError as e:
        print(f"ğŸŒ Google API Error: {e}")
        return "REQUEST_ERROR"
    except Exception as e:
        print(f"âš ï¸ Unexpected error:  {e}")
        return "UNEXPECTED_ERROR"

# --- 4. Main chatbot (ÄÃƒ Cáº¢I TIáº¾N) ---
def main():
    try:
        mic = sr.Microphone()
    except Exception as e:
        speak_and_print(f"Error:  Could not initialize Microphone. Details: {e}")
        return

    with mic as source:  
        speak_and_print("Please wait.  Adjusting for ambient noise...")
        robot_ear.adjust_for_ambient_noise(source, duration=2. 0)
        speak_and_print("Adjustment complete.  Ready!")
        
        intro = ("Hello! I am your virtual assistant to help you practice English speaking. "
                 "We have 9 units, each with 3 questions. Choose a unit from 1 to 9.")
        speak_and_print(intro)
        
        current_unit = None
        current_question_index = 0
        
        while True:
            if current_unit is None:
                speak_and_print("Please choose a unit from 1 to 9.")
                time.sleep(2)
                
                # â­ Sá»­ dá»¥ng hÃ m nghe má»›i
                user_input = listen_with_timeout_improved(
                    source, 
                    timeout_seconds=10, 
                    pause_threshold=2.0
                ).lower()
                
                if user_input in ["TIMEOUT", "UNKNOWN_VALUE", "REQUEST_ERROR", "UNEXPECTED_ERROR"]:
                    speak_and_print("Could not recognize.  Please try again.")
                    continue

                if "bye" in user_input:
                    speak_and_print("Goodbye!  Happy practicing.")
                    break
                
                unit_num = word_to_int(user_input)
                
                if unit_num and 1 <= unit_num <= 9:
                    current_unit = unit_num
                    current_question_index = 0
                    speak_and_print(f"Unit {current_unit} selected. Let's start!")
                else:
                    speak_and_print("Invalid unit.  Say a number from 1 to 9.")
                    continue
            
            questions = units[current_unit]
            if current_question_index < len(questions):
                question = questions[current_question_index]
                speak_and_print(f"\n--- Unit {current_unit}, Question {current_question_index + 1} ---")
                speak_and_print(question)
                time.sleep(3)
                
                # â­ Nghe vá»›i thá»i gian dÃ i, khÃ´ng giá»›i háº¡n
                user_answer = listen_with_timeout_improved(
                    source, 
                    timeout_seconds=15,     # Chá» 15s Ä‘á»ƒ báº¯t Ä‘áº§u
                    phrase_timeout=None,    # KhÃ´ng giá»›i háº¡n Ä‘á»™ dÃ i
                    pause_threshold=3.0     # Im láº·ng 3s â†’ káº¿t thÃºc
                )
                
                if user_answer in ["TIMEOUT", "UNKNOWN_VALUE", "REQUEST_ERROR", "UNEXPECTED_ERROR"]: 
                    speak_and_print("Could not hear clearly.  Skipping.  Say 'continue' or 'change'.")
                else:
                    if "bye" in user_answer. lower():
                        speak_and_print("Goodbye!")
                        break
                    
                    # â­ Feedback cáº£i tiáº¿n
                    feedback = generate_feedback_improved(user_answer)
                    speak_and_print(feedback)
                    
                    # â­ CHá»œ NGÆ¯á»œI DÃ™NG Äá»ŒC FEEDBACK
                    print("\n" + "="*70)
                    print("â³ Take your time to read the feedback above...")
                    print("="*70)
                    
                    speak_and_print("Have you finished reading? Say 'yes' or 'continue'.")
                    time.sleep(2)
                    
                    confirmation = listen_with_timeout_improved(
                        source, 
                        timeout_seconds=20, 
                        pause_threshold=2.0
                    ).lower()
                    
                    if any(word in confirmation for word in ["yes", "yeah", "ok", "continue", "ready"]):
                        speak_and_print("Great! Let's move on.")
                    else:
                        speak_and_print("Take your time. Say 'ready' when you want to continue.")
                        time.sleep(3)
                
                speak_and_print("Do you want to 'continue', 'change' unit, or say 'bye'?")
                time.sleep(2)
                
                choice = listen_with_timeout_improved(
                    source, 
                    timeout_seconds=10, 
                    pause_threshold=2.0
                ).lower()
                
                if "bye" in choice:
                    speak_and_print("Goodbye!  Thank you for practicing.")
                    break
                elif "continue" in choice:
                    current_question_index += 1
                    if current_question_index >= len(questions):
                        speak_and_print("Unit completed! Choose a new unit.")
                        current_unit = None
                elif "change" in choice:
                    speak_and_print("Choose a new unit from 1 to 9.")
                    current_unit = None
                else: 
                    speak_and_print("Not understood.  Continuing to next question.")
                    current_question_index += 1
                    if current_question_index >= len(questions):
                        speak_and_print("Unit completed! Choose a new unit.")
                        current_unit = None
            else:
                speak_and_print("Unit completed! Choose a new unit.")
                current_unit = None

if __name__ == "__main__":
    print("="*70)
    print("ğŸ™ï¸  VIRTUAL ASSISTANT - ENGLISH SPEAKING PRACTICE (IMPROVED VERSION)")
    print("="*70)
    main()
```

---

## ğŸ”§ HÆ°á»›ng dáº«n cÃ i Ä‘áº·t

### BÆ°á»›c 1: CÃ i Ä‘áº·t Python
- Táº£i Python 3.8+ tá»« [python.org](https://www.python.org/downloads/)
- **LÆ¯U Ã:** Tick chá»n "Add Python to PATH" khi cÃ i Ä‘áº·t

### BÆ°á»›c 2: CÃ i Ä‘áº·t cÃ¡c thÆ° viá»‡n

**Táº¡o file `requirements.txt`:**
```
SpeechRecognition==3.10.0
pyttsx3==2.90
language-tool-python==2.7.1
PyAudio==0.2.13
```

**CÃ i Ä‘áº·t:**

#### TrÃªn Windows:
```bash
# CÃ i PyAudio (cáº§n cÃ i riÃªng trÆ°á»›c)
pip install pipwin
pipwin install pyaudio

# CÃ i cÃ¡c thÆ° viá»‡n khÃ¡c
pip install -r requirements.txt
```

#### TrÃªn macOS:
```bash
# CÃ i PyAudio
brew install portaudio
pip install pyaudio

# CÃ i cÃ¡c thÆ° viá»‡n khÃ¡c
pip install -r requirements. txt
```

#### TrÃªn Linux:
```bash
# CÃ i cÃ¡c dependencies
sudo apt-get install python3-pyaudio portaudio19-dev

# CÃ i cÃ¡c thÆ° viá»‡n
pip install -r requirements.txt
```

### BÆ°á»›c 3: Kiá»ƒm tra cÃ i Ä‘áº·t

**Táº¡o file test:**
```python
# test_setup.py
import speech_recognition as sr
import pyttsx3
import language_tool_python

print("âœ… All libraries imported successfully!")

# Test microphone
try:
    mic = sr.Microphone()
    print("âœ… Microphone detected!")
except: 
    print("âŒ No microphone detected!")

# Test text-to-speech
try:
    engine = pyttsx3.init()
    engine.say("Hello")
    engine.runAndWait()
    print("âœ… Text-to-speech works!")
except:
    print("âŒ Text-to-speech failed!")

# Test LanguageTool
try: 
    tool = language_tool_python.LanguageTool('en-US')
    print("âœ… LanguageTool initialized!")
except:
    print("âŒ LanguageTool failed!")
```

**Cháº¡y test:**
```bash
python test_setup.py
```

---

## ğŸ“– HÆ°á»›ng dáº«n sá»­ dá»¥ng

### Cháº¡y chÆ°Æ¡ng trÃ¬nh

```bash
python banchaythu_fixed.py
```

### Luá»“ng sá»­ dá»¥ng

1. **Khá»Ÿi Ä‘á»™ng:**
   ```
   Robot: "Please wait. Adjusting for ambient noise..."
   Robot: "Adjustment complete. Ready!"
   Robot: "Hello! I am your virtual assistant..."
   ```

2. **Chá»n Unit:**
   ```
   Robot: "Please choose a unit from 1 to 9."
   You: "Number three"  (hoáº·c "3" hoáº·c "unit three")
   Robot: "Unit 3 selected. Let's start!"
   ```

3. **Tráº£ lá»i cÃ¢u há»i:**
   ```
   Robot: "Describe your family."
   [Báº¡n cÃ³ thá»ƒ nÃ³i thoáº£i mÃ¡i, dÃ i ngáº¯n tuá»³ Ã½]
   [Im láº·ng 3 giÃ¢y â†’ Tá»± Ä‘á»™ng káº¿t thÃºc]
   ```

4. **Nháº­n feedback:**
   ```
   â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
   â•‘         ğŸ“Š FEEDBACK                â•‘
   â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£
   â•‘ ğŸ¤ Your speech:  "My family has..." 
   â•‘ âœï¸ Correction: "My family has..."   
   â•‘ ğŸ“ Length: âœ… Good length          
   â•‘ ğŸ“ Grammar: âœ… Perfect!             
   â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   
   Robot: "Have you finished reading? Say 'yes'."
   You: "Yes"
   ```

5. **Tiáº¿p tá»¥c hoáº·c Ä‘á»•i unit:**
   ```
   Robot: "Do you want to continue, change, or bye?"
   You: "Continue"  â†’ CÃ¢u há»i tiáº¿p theo
   You: "Change"    â†’ Chá»n unit má»›i
   You: "Bye"       â†’ Káº¿t thÃºc
   ```

---

## ğŸ› Xá»­ lÃ½ lá»—i thÆ°á»ng gáº·p

### Lá»—i 1: "No module named 'pyaudio'"

**NguyÃªn nhÃ¢n:** ChÆ°a cÃ i PyAudio

**Giáº£i phÃ¡p:**
```bash
# Windows
pip install pipwin
pipwin install pyaudio

# Mac
brew install portaudio
pip install pyaudio

# Linux
sudo apt-get install python3-pyaudio
```

### Lá»—i 2: "Could not initialize Microphone"

**NguyÃªn nhÃ¢n:** 
- KhÃ´ng cÃ³ microphone
- Microphone bá»‹ á»©ng dá»¥ng khÃ¡c chiáº¿m dá»¥ng
- KhÃ´ng cÃ³ quyá»n truy cáº­p microphone

**Giáº£i phÃ¡p:**
1. Kiá»ƒm tra microphone cÃ³ hoáº¡t Ä‘á»™ng khÃ´ng
2. Táº¯t cÃ¡c á»©ng dá»¥ng khÃ¡c Ä‘ang dÃ¹ng micro (Zoom, Discord...)
3. Cáº¥p quyá»n truy cáº­p micro cho Terminal/Command Prompt: 
   - **Mac:** System Preferences â†’ Security & Privacy â†’ Microphone
   - **Windows:** Settings â†’ Privacy â†’ Microphone

### Lá»—i 3: "REQUEST_ERROR" (Google API)

**NguyÃªn nhÃ¢n:** KhÃ´ng cÃ³ káº¿t ná»‘i internet

**Giáº£i phÃ¡p:**
1. Kiá»ƒm tra káº¿t ná»‘i máº¡ng
2. Thá»­ láº¡i sau vÃ i giÃ¢y

### Lá»—i 4: LanguageTool cháº­m láº§n Ä‘áº§u

**NguyÃªn nhÃ¢n:** LanguageTool táº£i dá»¯ liá»‡u láº§n Ä‘áº§u (khoáº£ng 100MB)

**Giáº£i phÃ¡p:** Chá» 1-2 phÃºt cho láº§n cháº¡y Ä‘áº§u tiÃªn

---

## ğŸ“Š So sÃ¡nh trÆ°á»›c vÃ  sau

| TiÃªu chÃ­ | TrÆ°á»›c | Sau |
|----------|-------|-----|
| **Kiá»ƒm tra ngá»¯ phÃ¡p** | TextBlob (cÆ¡ báº£n) | LanguageTool (nÃ¢ng cao) âœ… |
| **Thá»i gian nÃ³i** | Tá»‘i Ä‘a 30s | KhÃ´ng giá»›i háº¡n âœ… |
| **Im láº·ng Ä‘á»ƒ káº¿t thÃºc** | 0.8s (quÃ¡ nhanh) | 3.0s (vá»«a pháº£i) âœ… |
| **Feedback** | Hiá»ƒn thá»‹ â†’ Há»i ngay | Chá» xÃ¡c nháº­n Ä‘Ã£ Ä‘á»c âœ… |
| **Tá»‘c Ä‘á»™ robot nÃ³i** | 150-200 (nhanh) | 140 (vá»«a pháº£i) âœ… |
| **Chi phÃ­** | Miá»…n phÃ­ | Miá»…n phÃ­ âœ… |

---

## ğŸš€ HÆ°á»›ng phÃ¡t triá»ƒn tiáº¿p theo

### 1. LÆ°u lá»‹ch sá»­ há»c táº­p
```python
import json
from datetime import datetime

# LÆ°u vÃ o file JSON
history = {
    "date": datetime.now().strftime("%Y-%m-%d %H:%M"),
    "unit": current_unit,
    "question": question,
    "answer": user_answer,
    "errors": len(matches)
}

with open("history.json", "a") as f:
    json.dump(history, f)
    f.write("\n")
```

### 2. ThÃªm giao diá»‡n Ä‘á»“ há»a (GUI)
- DÃ¹ng **Tkinter** hoáº·c **PyQt5**
- Hiá»ƒn thá»‹ feedback dá»… Ä‘á»c hÆ¡n
- NÃºt báº¥m thay vÃ¬ chá»‰ giá»ng nÃ³i

### 3. ThÃªm cháº¥m Ä‘iá»ƒm
```python
def calculate_score(word_count, error_count):
    length_score = min(word_count / 20 * 50, 50)  # Tá»‘i Ä‘a 50 Ä‘iá»ƒm
    grammar_score = max(50 - error_count * 10, 0)  # Má»—i lá»—i trá»« 10 Ä‘iá»ƒm
    total = length_score + grammar_score
    return round(total, 1)
```

### 4. Há»— trá»£ nhiá»u ngÃ´n ngá»¯
```python
# Chá»n ngÃ´n ngá»¯
language = "vi-VN"  # Tiáº¿ng Viá»‡t
language = "en-US"  # Tiáº¿ng Anh

user_text = robot_ear.recognize_google(audio, language=language)
```

### 5. Xuáº¥t bÃ¡o cÃ¡o PDF
```python
from fpdf import FPDF

def generate_report(history):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)
    pdf.cell(200, 10, txt="Learning Report", ln=True)
    # ...  thÃªm dá»¯ liá»‡u
    pdf.output("report.pdf")
```

---

## ğŸ“ LiÃªn há»‡ vÃ  há»— trá»£

Náº¿u gáº·p váº¥n Ä‘á» khi sá»­ dá»¥ng: 
1. Táº¡o Issue trÃªn GitHub:  [hdung1205/trolyao/issues](https://github.com/hdung1205/trolyao/issues)
2. Kiá»ƒm tra log lá»—i vÃ  gá»­i kÃ¨m khi bÃ¡o lá»—i
3. MÃ´ táº£ chi tiáº¿t: 
   - Há»‡ Ä‘iá»u hÃ nh (Windows/Mac/Linux)
   - PhiÃªn báº£n Python
   - CÃ¡c bÆ°á»›c tÃ¡i hiá»‡n lá»—i

---

## ğŸ“ TÃ i liá»‡u tham kháº£o

- [SpeechRecognition Documentation](https://pypi.org/project/SpeechRecognition/)
- [pyttsx3 Documentation](https://pypi.org/project/pyttsx3/)
- [LanguageTool Python](https://pypi.org/project/language-tool-python/)
- [LanguageTool Official](https://languagetool.org/)

---

## ğŸ“ Changelog

### Version 2.0 (Improved) - 2025-12-21
- âœ… Thay TextBlob báº±ng LanguageTool
- âœ… Sá»­a thá»i gian nghe (bá» giá»›i háº¡n 30s)
- âœ… ThÃªm xÃ¡c nháº­n Ä‘Ã£ Ä‘á»c feedback
- âœ… Äiá»u chá»‰nh tá»‘c Ä‘á»™ nÃ³i robot
- âœ… Cáº£i thiá»‡n UI feedback vá»›i box Ä‘áº¹p
- âœ… ThÃªm emoji vÃ  mÃ u sáº¯c dá»… Ä‘á»c

### Version 1.0 (Original) - 2025-12-17
- PhiÃªn báº£n Ä‘áº§u tiÃªn vá»›i TextBlob

---

## â­ Káº¿t luáº­n

Sau khi Ã¡p dá»¥ng cÃ¡c cáº£i tiáº¿n trÃªn, trá»£ lÃ½ áº£o sáº½: 
- âœ… **Kiá»ƒm tra ngá»¯ phÃ¡p tá»‘t hÆ¡n** (LanguageTool miá»…n phÃ­)
- âœ… **Cho phÃ©p nÃ³i lÃ¢u hÆ¡n** (khÃ´ng giá»›i háº¡n 30s)
- âœ… **NgÆ°á»i dÃ¹ng cÃ³ thá»i gian Ä‘á»c feedback** (chá» xÃ¡c nháº­n)
- âœ… **Dá»… nghe hÆ¡n** (tá»‘c Ä‘á»™ nÃ³i cháº­m hÆ¡n)
- âœ… **100% miá»…n phÃ­** (khÃ´ng cáº§n API key tráº£ phÃ­)

ChÃºc báº¡n thÃ nh cÃ´ng vá»›i Ä‘á» tÃ i NCKH! ğŸ‰

---

**Made with â¤ï¸ for hdung1205/trolyao**