<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{citizen/layout/fragments :: head('Chi tiết hồ sơ ' + ${d.dossierCode})}"></head>

<body class="bg-light d-flex flex-column min-vh-100">

    <nav th:replace="~{citizen/layout/fragments :: header('hoso')}"></nav>

    <!-- CONTENT -->
    <main class="container mt-5 pt-5 mb-5">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a th:href="@{/}" class="text-decoration-none text-muted">Trang chủ</a></li>
                <li class="breadcrumb-item"><a th:href="@{/citizen/hoso/danh-sach}"
                        class="text-decoration-none text-muted">Hồ sơ của tôi</a></li>
                <li class="breadcrumb-item active text-primary fw-bold" th:text="'Chi tiết ' + ${d.dossierCode}">
                    G01-2405001</li>
            </ol>
        </nav>

        <div class="row g-4">
            <!-- Left: Info -->
            <div class="col-lg-8">
                <!-- Status Banner -->
                <div class="card card-modern border-0 shadow-sm p-4 mb-4"
                    th:classappend="${d.dossierStatus == 'APPROVED' ? 'border-start border-5 border-success' : (d.dossierStatus == 'REJECTED' ? 'border-start border-5 border-danger' : 'border-start border-5 border-primary')}">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h4 class="fw-bold text-dark mb-1" th:text="${d.serviceName}">Đăng ký khai sinh</h4>
                            <div class="d-flex gap-3 align-items-center">
                                <span class="fw-bold text-primary" th:text="${d.dossierCode}">G01-2405001</span>
                                <span class="text-muted small">|</span>
                                <span class="text-muted small"><i class="bi bi-calendar-event me-1"></i>Ngày nộp: <span
                                        th:text="${#temporals.format(d.submissionDate, 'dd/MM/yyyy HH:mm')}">15/05/2024</span></span>
                            </div>
                        </div>
                        <div class="text-end">
                            <span th:if="${d.dossierStatus == 'NEW'}"
                                class="badge bg-primary bg-opacity-10 text-primary border border-primary px-3 py-2 rounded-pill fw-bold">Hồ
                                sơ mới</span>
                            <span th:if="${d.dossierStatus == 'PENDING'}"
                                class="badge bg-info bg-opacity-10 text-info border border-info px-3 py-2 rounded-pill fw-bold">Đang
                                xử lý</span>
                            <span th:if="${d.dossierStatus == 'VERIFIED'}"
                                class="badge bg-purple bg-opacity-10 text-purple border border-purple px-3 py-2 rounded-pill fw-bold"
                                style="--bs-bg-opacity: .1; background-color: rgba(111, 66, 193, 0.1); color: #6f42c1; border-color: #6f42c1;">Đã
                                thẩm định</span>
                            <span th:if="${d.dossierStatus == 'NEED_SUPPLEMENT'}"
                                class="badge bg-warning bg-opacity-10 text-warning border border-warning px-3 py-2 rounded-pill fw-bold">Cần
                                bổ sung</span>
                            <span
                                th:if="${d.dossierStatus == 'APPROVED' or d.dossierStatus == 'COMPLETED' or d.dossierStatus == 'RESULT_RETURNED'}"
                                class="badge bg-success bg-opacity-10 text-success border border-success px-3 py-2 rounded-pill fw-bold">Đã
                                hoàn tất</span>
                            <span th:if="${d.dossierStatus == 'REJECTED'}"
                                class="badge bg-danger bg-opacity-10 text-danger border border-danger px-3 py-2 rounded-pill fw-bold">Từ
                                chối</span>
                        </div>
                    </div>

                </div>

                <!-- Process Timeline (Workflow Steps) -->
                <div class="card card-modern border-0 shadow-sm p-4 mb-4" th:if="${workflowSteps != null}">
                    <h5 class="fw-bold text-dark mb-4 border-start border-4 border-info ps-3">Quy trình thực hiện</h5>
                    <div class="timeline-steps">
                        <div th:each="step : ${workflowSteps}" class="d-flex gap-3 mb-4 last-no-border">
                            <!-- Step Number Circle -->
                            <div class="bg-primary text-white bg-gradient rounded-circle d-flex align-items-center justify-content-center flex-shrink-0 shadow-sm"
                                style="width: 32px; height: 32px; font-size: 14px; font-weight: bold;"
                                th:classappend="${step.stepOrder < currentStepOrder ? 'bg-success' : (step.stepOrder == currentStepOrder ? 'bg-primary' : 'bg-light text-muted border')}"
                                th:text="${step.stepOrder}">1</div>

                            <!-- Step Content -->
                            <div>
                                <h6 class="fw-bold mb-0"
                                    th:classappend="${step.stepOrder < currentStepOrder ? 'text-success' : (step.stepOrder == currentStepOrder ? 'text-primary' : 'text-dark')}"
                                    th:text="${step.stepName}">Tên bước</h6>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Form Data Display (Fragments) -->
                <div th:replace="~{citizen/dossier/fragments/birth_registration :: birth_registration(${d})}"></div>
                <div th:replace="~{citizen/dossier/fragments/business_household :: business_household(${d})}"></div>
                <div th:replace="~{citizen/dossier/fragments/death_registration :: death_registration(${d})}"></div>


                <!-- Uploaded Files -->
                <div class="card card-modern border-0 shadow-sm p-4 mb-4"
                    th:if="${d.dossierFiles != null and !d.dossierFiles.isEmpty()}">
                    <h5 class="fw-bold text-dark mb-4 border-start border-4 border-warning ps-3">Tệp tin đính kèm</h5>
                    <div class="list-group list-group-flush">
                        <div th:each="file : ${d.dossierFiles}"
                            class="list-group-item d-flex justify-content-between align-items-center px-0 bg-transparent border-light">
                            <div class="d-flex align-items-center">
                                <div class="bg-light rounded p-2 me-3">
                                    <i th:if="${file.fileType != null and file.fileType.contains('image')}"
                                        class="bi bi-file-earmark-image fs-4 text-primary"></i>
                                    <i th:if="${file.fileType != null and file.fileType.contains('pdf')}"
                                        class="bi bi-file-earmark-pdf fs-4 text-danger"></i>
                                    <i th:if="${file.fileType == null or (!file.fileType.contains('image') and !file.fileType.contains('pdf'))}"
                                        class="bi bi-file-earmark fs-4 text-secondary"></i>
                                </div>
                                <div>
                                    <div class="fw-bold text-dark small" th:text="${file.fileName}">filename.jpg</div>
                                    <div class="text-muted smallest" th:text="${file.fileType}">image/jpeg</div>
                                </div>
                            </div>
                            <a th:href="@{'/officer/dashboard/view-file/' + ${file.id}}" target="_blank"
                                class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                <i class="bi bi-eye me-1"></i>Xem tệp
                            </a>
                        </div>
                    </div>
                </div>

                <!-- History Timeline -->
                <div class="card card-modern border-0 shadow-sm p-4 mb-4">
                    <h5 class="fw-bold text-dark mb-4 border-start border-4 border-primary ps-3">Lịch sử xử lý</h5>
                    <div class="history-timeline">
                        <div th:each="log : ${history}" class="d-flex gap-3 mb-4 last-no-border">
                            <div class="flex-shrink-0 text-center" style="width: 60px;">
                                <div class="small fw-bold text-dark"
                                    th:text="${#temporals.format(log.createdAt, 'dd/MM')}">
                                    15/05</div>
                                <div class="small text-muted" th:text="${#temporals.format(log.createdAt, 'HH:mm')}">
                                    14:30</div>
                            </div>
                            <div class="flex-grow-1 ps-3 border-start position-relative">
                                <i class="bi bi-circle-fill text-primary position-absolute"
                                    style="left: -6px; top: 5px; font-size: 10px;"></i>
                                <h6 class="fw-bold text-dark mb-1" th:switch="${log.action}">
                                    <span th:case="'NOP_HO_SO'">Nộp hồ sơ</span>
                                    <span th:case="'ACCEPTED'">Tiếp nhận hồ sơ</span>
                                    <span th:case="'ASSIGNED'">Phân công xử lý</span>
                                    <span th:case="'CHUYEN_BUOC'">Chuyển bước xử lý</span>
                                    <span th:case="'THAM_DINH'">Thẩm định hồ sơ</span>
                                    <span th:case="'TRINH_KY'">Trình ký phê duyệt</span>
                                    <span th:case="'PHE_DUYET'">Lãnh đạo phê duyệt</span>
                                    <span th:case="'YEU_CAU_BO_SUNG'">Yêu cầu bổ sung</span>
                                    <span th:case="'TRA_KET_QUA'">Trả kết quả</span>
                                    <span th:case="'TU_CHOI'">Từ chối hồ sơ</span>
                                    <span th:case="*">Cập nhật hồ sơ</span>
                                </h6>
                                <p class="small text-muted mb-1" th:text="${log.comments}">Hồ sơ đã được cán bộ Nguyễn
                                    Văn B tiếp nhận và chuyển phòng chuyên môn.</p>
                                <div class="small text-primary fw-medium" th:if="${log.actorName != null}">
                                    <i class="bi bi-person-check me-1"></i>Người xử lý: <span
                                        th:text="${log.actorName}">Nguyễn Văn B</span>
                                </div>
                            </div>
                        </div>
                        <div th:if="${history == null or history.isEmpty()}" class="text-center py-4 text-muted small">
                            Chưa có lịch sử xử lý cho hồ sơ này.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right: Details -->
            <div class="col-lg-4">
                <div class="card card-modern border-0 shadow-sm p-4 sticky-top" style="top: 100px;">
                    <h5 class="fw-bold text-dark mb-3">Thông tin chi tiết</h5>
                    <div class="mb-4">
                        <label class="small text-muted d-block opacity-75">Họ và tên người nộp</label>
                        <span class="fw-bold" th:text="${d.applicantFullName}">Nguyễn Văn A</span>
                    </div>
                    <div class="mb-4">
                        <label class="small text-muted d-block opacity-75">Ngày nộp hồ sơ</label>
                        <span class="fw-bold"
                            th:text="${#temporals.format(d.submissionDate, 'dd/MM/yyyy HH:mm')}">15/05/2024 14:30</span>
                    </div>
                    <div class="mb-4">
                        <label class="small text-muted d-block opacity-75">Mã số hồ sơ</label>
                        <span class="fw-bold font-monospace" th:text="${d.dossierCode}">G01-2405001</span>
                    </div>
                    <hr class="opacity-10">

                    <!-- Result Section -->
                    <!--                    <div th:if="${(d.dossierStatus == 'RESULT_RETURNED' or d.dossierStatus == 'COMPLETED') and d.resultFileUrl != null}"-->
                    <div th:if="${(d.dossierStatus == 'RESULT_RETURNED') and d.resultFileUrl != null}"
                        class="mt-4 p-3 bg-success bg-opacity-10 border border-success border-opacity-20 rounded-3 text-center">
                        <div class="mb-2">
                            <i class="bi bi-patch-check-fill text-success fs-3"></i>
                        </div>
                        <h6 class="fw-bold text-success mb-2">Hồ sơ đã có kết quả</h6>
                        <div class="mb-3 small">
                            <span class="text-muted">Số quyết định:</span>
                            <span class="fw-bold text-dark" th:text="${d.decisionNumber}">123/QD-UBND</span>
                        </div>
                        <p class="small text-muted mb-3">Bạn có thể xem và tải về bản tệp kết quả điện tử bên dưới.</p>
                        <a th:href="@{'/citizen/view-result-file/' + ${d.dossierId}}" target="_blank"
                            class="btn btn-success rounded-pill w-100 fw-bold">
                            <i class="bi bi-file-earmark-pdf me-2"></i>Xem kết quả PDF
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer th:replace="~{citizen/layout/fragments :: footer}"></footer>

</body>

</html>