<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tiếp nhận Hồ sơ - Hệ thống Một cửa</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <!-- SockJS và STOMP (Dùng CDN cho nhanh) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/assets/css/style.css}">
    <link rel="stylesheet" th:href="@{/assets/css/internal.css}">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --sidebar-width: 280px;
            --header-height: 70px;
            --primary-gradient: linear-gradient(135deg, #0f4c81 0%, #1e6091 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: 1px solid rgba(255, 255, 255, 0.2);
            --card-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.05);
            --hover-shadow: 0 20px 40px -5px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            /* Slate-100 */
            color: #334155;
            overflow-x: hidden;
        }

        /* Sidebar Styling */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            background: #fff;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.02);
            transition: all 0.3s ease;
        }

        .sidebar-header {
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 1.5rem;
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(15, 76, 129, 0.2);
        }

        .nav-link-custom {
            display: flex;
            align-items: center;
            padding: 0.85rem 1.5rem;
            color: #64748b;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s ease;
            border-right: 3px solid transparent;
            margin-bottom: 4px;
        }

        .nav-link-custom:hover {
            background-color: #f8fafc;
            color: var(--bs-primary);
        }

        .nav-link-custom.active {
            background-color: #f0f9ff;
            color: var(--bs-primary);
            border-right-color: var(--bs-primary);
            font-weight: 600;
        }

        .nav-link-custom i {
            font-size: 1.25rem;
            width: 2rem;
            text-align: center;
            margin-right: 0.5rem;
        }

        /* Main Content Layout */
        .main-content {
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header Styling */
        .top-header {
            height: var(--header-height);
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid #e2e8f0;
            position: sticky;
            top: 0;
            z-index: 900;
            padding: 0 2rem;
        }

        /* Dashboard Cards */
        .dashboard-card {
            background: #fff;
            border: none;
            border-radius: 16px;
            box-shadow: var(--card-shadow);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--hover-shadow);
        }

        /* Button Styling */
        .btn-action {
            border-radius: 50rem;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: all 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>

<body th:object="${dossier}">

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="sidebar-header">
            <i class="bi bi-building-fill-gear fs-4 me-3"></i>
            <div>
                <div class="fw-bold" style="letter-spacing: 0.5px;">HỆ THỐNG</div>
                <div style="font-size: 0.8rem; opacity: 0.9;">MỘT CỬA ĐIỆN TỬ</div>
            </div>
        </div>

        <div class="py-4">
            <small class="text-uppercase fw-bold text-muted px-4 mb-2 d-block"
                style="font-size: 0.75rem; letter-spacing: 1px;">Nghiệp vụ</small>

            <a th:href="@{/officer/dashboard}" class="nav-link-custom active">
                <i class="bi bi-grid-fill"></i>
                Bàn làm việc
            </a>

            <a th:href="@{/officer/dashboard/return}" class="nav-link-custom">
                <i class="bi bi-check2-circle"></i>
                Trả kết quả
            </a>


            <div class="my-4 border-top mx-4 op-2"></div>

            <small class="text-uppercase fw-bold text-muted px-4 mb-2 d-block"
                style="font-size: 0.75rem; letter-spacing: 1px;">Hệ thống</small>
            <a th:href="@{/logout/officer}" class="nav-link-custom text-danger hover-danger">
                <i class="bi bi-box-arrow-left"></i>
                Đăng xuất
            </a>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">

        <!-- TOP NAVBAR -->
        <nav class="top-header d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <span class="bg-primary bg-opacity-10 text-primary p-2 rounded-circle me-3">
                    <i class="bi bi-bank2"></i>
                </span>
                <div>
                    <div class="fw-bold text-dark" th:text="'UBND '+${departmentName}"></div>
                    <small class="text-muted">Bộ phận Một cửa - Tiếp nhận & Trả kết quả</small>
                </div>
            </div>

            <div class="d-flex align-items-center gap-4">
                <!-- Notifications Example -->
                <button class="btn btn-light rounded-circle position-relative border-0 shadow-sm"
                    style="width: 40px; height: 40px;">
                    <i class="bi bi-bell-fill text-muted"></i>
                    <span
                        class="position-absolute top-0 start-100 translate-middle p-1 bg-danger border border-light rounded-circle"></span>
                </button>

                <!-- Profile Dropdown -->
                <div class="dropdown">
                    <a href="#"
                        class="d-flex align-items-center text-dark text-decoration-none dropdown-toggle px-3 py-2 rounded-pill bg-white shadow-sm border"
                        data-bs-toggle="dropdown">
                        <img src="https://ui-avatars.com/api/?name=Can+Bo&background=0f4c81&color=fff"
                            class="rounded-circle me-2" width="32" height="32">
                        <div class="d-flex flex-column me-2" style="line-height: 1.1;">
                            <span class="fw-bold small" th:text="${officerName}"></span>
                            <small class="text-muted" style="font-size: 0.7rem;">Cán bộ tiếp nhận</small>
                        </div>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3 mt-2">
                        <li>
                            <h6 class="dropdown-header">Tài khoản</h6>
                        </li>
                        <li><a class="dropdown-item" href="#"><i class="bi bi-person me-2"></i>Hồ sơ cá nhân</a></li>
                        <li>
                            <hr class="dropdown-divider">
                        </li>
                        <li><a class="dropdown-item text-danger" th:href="@{/logout/officer}"><i
                                    class="bi bi-box-arrow-right me-2"></i>Đăng
                                xuất</a></li>
                    </ul>
                </div>
            </div>
        </nav>

        <main class="p-4 flex-grow-1">

            <div class="row">
                <!-- LEFT COL: SEARCH & INFO -->
                <div class="col-lg-8">
                    <!-- 2. CITIZEN INFO -->
                    <div class="dashboard-card mb-4 p-4">
                        <h6 class="fw-bold mb-4 d-flex align-items-center text-primary">
                            <i class="bi bi-person-vcard-fill me-2 fs-5"></i>
                            Thông tin người nộp
                        </h6>

                        <div class="row g-4">
                            <div class="col-md-6">
                                <label class="form-label small text-muted fw-bold text-uppercase">Họ và tên</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="bi bi-person text-muted"></i></span>
                                    <input th:value="${dossier.applicantFullName}" type="text"
                                        class="form-control border-start-0 ps-0 fw-medium text-dark" readonly
                                        style="background-color: #f8fafc;">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small text-muted fw-bold text-uppercase">Số CCCD</label>
                                <div class="input-group">
                                    <span class="input-group-text bg-white border-end-0"><i
                                            class="bi bi-card-heading text-muted"></i></span>
                                    <input type="text" class="form-control border-start-0 ps-0 fw-medium text-dark"
                                        th:value="${dossier.cccd}" readonly style="background-color: #f8fafc;">
                                </div>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label small text-muted fw-bold text-uppercase">Thủ tục đăng
                                    ký</label>
                                <div
                                    class="p-3 bg-primary bg-opacity-10 rounded border border-primary border-opacity-25 text-primary fw-semibold">
                                    <i class="bi bi-file-earmark-text me-2"></i>
                                    <span th:text="${dossier.serviceName}"></span>
                                </div>
                            </div>
                            <div class="card border-0 shadow-sm bg-white">
                                <div class="card-header bg-white border-bottom py-3">
                                    <h6 class="m-0 fw-bold text-primary"><i class="bi bi-file-text me-2"></i>Chi tiết tờ
                                        khai</h6>
                                    <!--                                    <div class="alert alert-info">-->
                                    <!--                                        Kiểu dữ liệu: <span th:text="${formData.getClass().getName()}"></span> <br/>-->
                                    <!--                                        Giá trị: <span th:text="${formData}"></span>-->
                                    <!--                                    </div>-->
                                </div>
                                <div class="card-body p-4">

                                    <th:block th:if="${formData != null}">
                                        <div th:replace="~{__${formFragment}__}"></div>
                                    </th:block>
                                    <th:block th:if="${formData == null}">
                                        <div class="alert alert-warning text-center">
                                            Hồ sơ này chưa có dữ liệu tờ khai điện tử.
                                        </div>
                                    </th:block>

                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 3. DOC CHECKLIST -->
                    <div class="dashboard-card mb-4 overflow-hidden" th:object="${files}">
                        <div class="p-4 border-bottom bg-light bg-gradient">
                            <h6 class="fw-bold mb-0 d-flex align-items-center text-success">
                                <i class="bi bi-check2-square me-2 fs-5"></i>Thành phần hồ sơ
                            </h6>
                        </div>
                        <div class="list-group list-group-flush">
                            <label th:each="file :${files}"
                                class="list-group-item p-4 d-flex gap-3 align-items-center border-bottom-0 border-top hover-bg-light">
                                <div class="form-check">
                                    <!-- Use a real checkbox just for visuals if needed, or keeping the svg icon -->
                                    <input class="form-check-input fs-5 bg-success border-success" type="checkbox"
                                        checked disabled>
                                </div>

                                <div class="d-flex flex-column flex-grow-1">
                                    <strong class="text-dark" th:text="${file.fileName}"></strong>
                                    <small class="text-muted mt-1">Đã điền đầy đủ theo mẫu TP/HT-2024</small>
                                </div>
                                <button type="button"
                                    class="btn btn-sm btn-light border shadow-sm text-primary fw-bold btn-view-file"
                                    th:data-file-id="${file.getId()}" th:data-file-name="${file.fileName}"
                                    th:data-file-type="${file.fileType}" data-bs-toggle="tooltip" title="Xem trước tệp">
                                    <i class="bi bi-eye me-1"></i> Xem
                                </button>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- RIGHT COL: FEES & ACTION -->
                <div class="col-lg-4">
                    <!-- Actions Panel -->
                    <div class="dashboard-card p-4 text-center sticky-top" style=" z-index: 100;">
                        <div class="mb-4">
                            <div class="bg-primary bg-opacity-10 rounded-circle d-inline-flex p-3 text-primary mb-3">
                                <i class="bi bi-check-circle-fill fs-2"></i>
                            </div>
                            <h5 class="fw-bold">Xác nhận tiếp nhận</h5>
                            <p class="text-muted small">Vui lòng kiểm tra kỹ thông tin hồ sơ trước khi tiếp nhận vào hệ
                                thống.</p>
                        </div>

                        <div class="d-grid gap-3">
                            <button type="button" class="btn btn-primary btn-action text-white" data-bs-toggle="modal"
                                data-bs-target="#assignModal">
                                <i class="bi bi-printer-fill me-2"></i>Tiếp nhận & chuyển tiếp hồ sơ
                            </button>

                            <button class="btn btn-outline-warning btn-action border-2" data-bs-toggle="modal"
                                data-bs-target="#supplementModal">
                                <i class="bi bi-arrow-counterclockwise"></i> Yêu cầu bổ sung
                            </button>
                            <button class="btn btn-outline-danger btn-action border-2" data-bs-toggle="modal"
                                data-bs-target="#rejectModal">
                                <i class="bi bi-arrow-return-left me-2"></i> Từ chối hồ sơ
                            </button>
                        </div>

                        <div class="mt-4 pt-3 border-top">
                            <small class="text-muted d-block mb-1">Thời gian nộp:</small>
                            <strong th:text="${#temporals.format(dossier.submissionDate, 'dd/MM/yyyy HH:mm')}"
                                class="text-dark"><i class="bi bi-clock me-1"></i> </strong>
                        </div>
                    </div>

                </div>
            </div>

        </main>
    </div>

    <!-- Modals Include -->
    <th:block th:replace="~{components/modals/supplement-reason-modal :: supplementReasonModal}"></th:block>
    <th:block th:replace="~{components/modals/reject-reason-modal :: rejectReasonModal}"></th:block>
    <th:block th:replace="~{components/modals/assign-specialist-modal :: assignModal}"></th:block>
    <th:block th:replace="~{components/modals/view-file-modal :: viewFileModal}"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <!-- File Preview Modal Script (Officer version) -->
    <script>
        // Event delegation for view file buttons
        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.btn-view-file');
            if (btn) {
                const fileId = btn.dataset.fileId;
                const fileName = btn.dataset.fileName;
                const fileType = btn.dataset.fileType;
                openFileModal(fileId, fileName, fileType);
            }
        });

        function openFileModal(fileId, fileName, fileType) {
            const modal = new bootstrap.Modal(document.getElementById('viewFileModal'));

            // Reset all containers
            document.getElementById('fileLoadingState').classList.remove('d-none');
            document.getElementById('fileLoadingState').classList.add('d-flex');
            document.getElementById('fileErrorState').classList.remove('d-flex');
            document.getElementById('fileErrorState').classList.add('d-none');
            document.getElementById('pdfViewerContainer').classList.add('d-none');
            document.getElementById('imageViewerContainer').classList.remove('d-flex');
            document.getElementById('imageViewerContainer').classList.add('d-none');
            document.getElementById('docxViewerContainer').classList.add('d-none');
            document.getElementById('unsupportedFileContainer').classList.remove('d-flex');
            document.getElementById('unsupportedFileContainer').classList.add('d-none');

            // Set file name
            document.getElementById('fileNameDisplay').textContent = fileName;
            document.getElementById('viewFileModalLabel').textContent = fileName;

            // Build file URL - OFFICER endpoint
            const fileUrl = `/officer/dashboard/view-file/${fileId}`;

            // Set download links
            document.getElementById('downloadBtn').href = fileUrl;
            document.getElementById('downloadBtn').setAttribute('download', fileName);
            document.getElementById('fileDownloadFallback').href = fileUrl;
            document.getElementById('fileDownloadFallback').setAttribute('download', fileName);
            document.getElementById('unsupportedDownload').href = fileUrl;
            document.getElementById('unsupportedDownload').setAttribute('download', fileName);

            // Determine file type and show appropriate viewer
            const fileExt = fileName.split('.').pop().toLowerCase();
            let displayType = '';
            let iconClass = 'bi-file-earmark';

            modal.show();

            setTimeout(() => {
                // Hide loading
                document.getElementById('fileLoadingState').classList.remove('d-flex');
                document.getElementById('fileLoadingState').classList.add('d-none');

                if (fileExt === 'pdf') {
                    displayType = 'PDF';
                    iconClass = 'bi-file-earmark-pdf';
                    document.getElementById('pdfViewer').src = fileUrl;
                    document.getElementById('pdfViewerContainer').classList.remove('d-none');

                } else if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(fileExt)) {
                    displayType = fileExt.toUpperCase();
                    iconClass = 'bi-file-earmark-image';
                    document.getElementById('imageViewer').src = fileUrl;
                    document.getElementById('imageViewerContainer').classList.remove('d-none');
                    document.getElementById('imageViewerContainer').classList.add('d-flex');

                } else if (['doc', 'docx'].includes(fileExt)) {
                    displayType = fileExt.toUpperCase();
                    iconClass = 'bi-file-earmark-word';
                    const fullUrl = window.location.origin + fileUrl;
                    document.getElementById('docxNotice').innerHTML = `
                        <i class="bi bi-info-circle-fill me-3 fs-4"></i>
                        <div>
                            <strong>Lưu ý:</strong> Tệp Word (.${fileExt}) đang được tải trong trình xem tài liệu. 
                            Nếu không hiển thị được, vui lòng <a href="${fileUrl}" download="${fileName}" class="fw-bold text-primary">tải về</a> và mở bằng Microsoft Word.
                        </div>
                    `;
                    document.getElementById('docxViewer').src = `https://view.officeapps.live.com/op/embed.aspx?src=${encodeURIComponent(fullUrl)}`;
                    document.getElementById('docxViewerContainer').classList.remove('d-none');

                } else if (['xls', 'xlsx'].includes(fileExt)) {
                    displayType = fileExt.toUpperCase();
                    iconClass = 'bi-file-earmark-excel';
                    document.getElementById('unsupportedFileType').textContent = `Tệp Excel (${fileExt.toUpperCase()}) không thể xem trước. Vui lòng tải về.`;
                    document.getElementById('unsupportedFileContainer').classList.remove('d-none');
                    document.getElementById('unsupportedFileContainer').classList.add('d-flex');

                } else {
                    displayType = fileExt.toUpperCase() || 'UNKNOWN';
                    iconClass = 'bi-file-earmark';
                    document.getElementById('unsupportedFileType').textContent = `Định dạng tệp (${displayType}) không hỗ trợ xem trước`;
                    document.getElementById('unsupportedFileContainer').classList.remove('d-none');
                    document.getElementById('unsupportedFileContainer').classList.add('d-flex');
                }

                // Update file type display
                document.getElementById('fileTypeText').textContent = displayType;

                // Update icon with file-type specific color
                const iconEl = document.getElementById('fileTypeIcon');
                iconEl.className = `bi ${iconClass}`;
                iconEl.style.fontSize = '1.75rem';

                // Set color based on file type
                let iconColor = '#0f4c81';
                if (fileExt === 'pdf') {
                    iconColor = '#dc3545';
                } else if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(fileExt)) {
                    iconColor = '#6f42c1';
                } else if (['doc', 'docx'].includes(fileExt)) {
                    iconColor = '#2b579a';
                } else if (['xls', 'xlsx'].includes(fileExt)) {
                    iconColor = '#217346';
                }
                iconEl.style.color = iconColor;

            }, 300);
        }

        // Clean up when modal is closed
        document.getElementById('viewFileModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('pdfViewer').src = '';
            document.getElementById('imageViewer').src = '';
            document.getElementById('docxViewer').src = '';
        });
    </script>

    <!-- Toast Notification Component -->
    <th:block th:replace="~{components/toast/toast-notification :: toastContainer}"></th:block>
</body>

</html>