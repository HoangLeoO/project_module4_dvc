<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nộp Hồ sơ: Đăng ký khai tử - Dịch vụ công Đà Nẵng</title>
    <!-- Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/assets/css/style.css}">
    <link rel="stylesheet" th:href="@{/assets/css/portal.css}">
    <style>
        .wizard-step {
            position: relative;
            z-index: 1;
        }

        .wizard-step .btn-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            background: white;
            font-weight: bold;
            color: #6c757d;
        }

        .wizard-step.active .btn-circle {
            border-color: var(--bs-primary);
            background: var(--bs-primary);
            color: white;
        }

        .wizard-connector {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: 0;
        }
    </style>
</head>

<body class="bg-light">

    <!-- 1. HEADER -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm-soft py-3 bg-gradient-primary">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center fw-bold fs-4" th:href="@{/citizen/dashboard}">
                <i class="bi bi-bank2 me-2"></i>DỊCH VỤ CÔNG ĐÀ NẴNG
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#landingNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="landingNav">
                <ul class="navbar-nav ms-auto gap-3 mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link fw-medium text-white-50 hover-white"
                            th:href="@{/citizen/dashboard}">Trang chủ</a></li>
                    <li class="nav-item"><a class="nav-link fw-medium text-white-50 hover-white"
                            th:href="@{/citizen/services}">Dịch vụ công</a></li>
                    <li class="nav-item"><a class="nav-link fw-medium text-white-50 hover-white" href="#">Hướng dẫn</a>
                    </li>
                    <li class="nav-item"><a class="nav-link fw-medium text-white-50 hover-white"
                            th:href="@{/citizen/feedback}">Phản ánh kiến nghị</a></li>
                </ul>
                <div class="ms-lg-4">
                    <!-- User Profile -->
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
                            data-bs-toggle="dropdown">
                            <img th:src="@{'https://ui-avatars.com/api/?name=' + ${#authentication.principal.fullName} + '&background=random'}"
                                class="rounded-circle me-2" width="32">
                            <span th:text="${#authentication.principal.fullName}">Người dùng</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                            <li><a class="dropdown-item" th:href="@{/citizen/profile}"><i
                                        class="bi bi-person me-2"></i>Thông tin cá nhân</a></li>
                            <li><a class="dropdown-item" th:href="@{/citizen/vault}"><i class="bi bi-safe me-2"></i>Kho
                                    dữ
                                    liệu số</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" th:href="@{/logout/citizen}"><i
                                        class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="container mt-5 pt-5 mb-5">

        <!-- Page Title -->
        <div class="text-center mb-5">
            <h2 class="fw-bold text-primary mb-2">Nộp Hồ sơ Trực tuyến</h2>
            <p class="text-muted fs-5">Thủ tục: <strong>Đăng ký khai tử</strong></p>
        </div>


        <!-- 2. WIZARD NAV -->
        <div class="position-relative mb-5 mx-auto" style="max-width: 800px;">
            <!-- Toast Container -->
            <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

            <div class="wizard-connector"></div>
            <div class="d-flex justify-content-between position-relative">

                <div class="wizard-step active" id="navStep1">
                    <div class="text-center">
                        <div class="btn-circle mx-auto mb-2">1</div>
                        <small class="fw-bold">Thông tin Người nộp</small>
                    </div>
                </div>

                <div class="wizard-step" id="navStep2">
                    <div class="text-center">
                        <div class="btn-circle mx-auto mb-2">2</div>
                        <small class="text-muted">Thông tin Người mất</small>
                    </div>
                </div>

                <div class="wizard-step" id="navStep3">
                    <div class="text-center">
                        <div class="btn-circle mx-auto mb-2">3</div>
                        <small class="text-muted">Thành phần Hồ sơ</small>
                    </div>
                </div>

                <div class="wizard-step" id="navStep4">
                    <div class="text-center">
                        <div class="btn-circle mx-auto mb-2">4</div>
                        <small class="text-muted">Lệ phí & Nộp</small>
                    </div>
                </div>

            </div>
        </div>

        <!-- WIZARD CONTENT -->
        <div class="card shadow-sm border-0 rounded-3 wizard-content mx-auto" style="max-width: 900px;">
            <div class="card-body p-4 p-lg-5">

                <form id="submissionForm" enctype="multipart/form-data">
                    <input type="hidden" name="serviceCode" th:value="${serviceCode}">
                    <input type="hidden" name="isOnTime" id="isOnTime" value="true">
                    <!-- STEP 1: APPLICANT INFO -->
                    <div id="step1">
                        <h5 class="fw-bold border-bottom pb-2 mb-4 text-primary">Bước 1: Thông tin Người đi khai</h5>

                        <div class="alert alert-info border-0 shadow-sm d-flex align-items-center">
                            <i class="bi bi-info-circle-fill fs-4 me-3"></i>
                            <div>
                                Dữ liệu được tự động điền từ Cơ sở dữ liệu Quốc gia về Dân cư (VNeID).
                            </div>
                        </div>



                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label text-muted small text-uppercase fw-bold">Họ và tên</label>
                                <input type="text" class="form-control bg-light fw-bold text-primary"
                                    name="relativeFullName"
                                    th:value="${opsDossier.formData != null ? opsDossier.formData['relativeFullName'] : ''}"
                                    readonly required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small text-uppercase fw-bold">Số CCCD/Định
                                    danh</label>
                                <input type="text" class="form-control bg-light" name="relativeIdNumber"
                                    id="searchCccdApplicant"
                                    th:value="${opsDossier.formData != null ? opsDossier.formData['relativeIdNumber'] : ''}"
                                    readonly required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small text-uppercase fw-bold">Ngày sinh</label>
                                <input type="text" class="form-control bg-light" name="relativeDateOfBirth"
                                    th:value="${opsDossier.formData != null ? opsDossier.formData['relativeDateOfBirth'] : ''}"
                                    readonly required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small text-uppercase fw-bold">Điện thoại</label>
                                <input type="text" class="form-control bg-light" name="relativePhoneNumber"
                                    th:value="${opsDossier.formData != null ? opsDossier.formData['relativePhoneNumber'] : ''}"
                                    pattern="0[0-9]{9}" placeholder="0905123456" required>
                                <div class="invalid-feedback">Số điện thoại phải có 10 số và bắt đầu bằng số 0.</div>
                            </div>
                            <div class="col-12">
                                <label class="form-label text-muted small text-uppercase fw-bold">Địa chỉ thường
                                    trú</label>
                                <input type="text" class="form-control bg-light" name="relativeAddress"
                                    th:value="${opsDossier.formData != null ? opsDossier.formData['relativeAddress'] : ''}"
                                    readonly required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small text-uppercase fw-bold">Mối quan hệ với người
                                    mất</label>
                                <select class="form-select" name="relativeRelationship" required>
                                    <option value="">-- Chọn Mối quan hệ --</option>
                                    <option value="con">Con</option>
                                    <option value="vo_chong">Vợ/Chồng</option>
                                    <option value="cha_me">Cha/Mẹ</option>
                                    <option value="nguoi_than_khac">Người thân khác</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small text-uppercase fw-bold">Nơi nộp hồ sơ</label>
                                <select class="form-select" name="receivingDeptId" required>
                                    <option value="">-- Chọn Đơn vị tiếp nhận --</option>
                                    <option th:each="dept : ${sysDepartment}" th:value="${dept.id}"
                                        th:text="${dept.deptName}"></option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <!-- STEP 2: DECEASED FORM -->
                    <div id="step2" class="d-none">
                        <h5 class="fw-bold border-bottom pb-2 mb-4 text-primary">Bước 2: Thông tin Người được khai tử
                        </h5>

                        <div id="formDeath">
                            <h6 class="fw-bold text-uppercase mb-3 text-secondary">A. Thông tin Người mất</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Tìm kiếm công dân (Nhập CCCD)</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="searchCccdDeceased"
                                            placeholder="Nhập số CCCD để tự động điền...">
                                        <input type="hidden" name="deceasedIdNumber" id="deceasedIdNumber">
                                        <button class="btn btn-primary" type="button" onclick="autoFillDeceased()">
                                            <i class="bi bi-search"></i> Kiểm tra & Điền
                                        </button>
                                        <div class="invalid-feedback">Không tìm thấy công dân hoặc CCCD không hợp lệ.
                                        </div>
                                    </div>
                                    <!-- Relationship Check Result -->
                                    <div id="relationCheckResult" class="mt-2 small"></div>
                                    <input type="hidden" id="isRelationValid" value="false">
                                </div>
                                <div class="col-md-8">
                                    <label class="form-label required">Họ và tên người mất <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control text-uppercase bg-light"
                                        name="deceasedFullName" placeholder="VD: NGUYỄN VĂN A" readonly required>
                                    <div class="invalid-feedback">Vui lòng nhập họ tên người mất.</div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Giới tính <span class="text-danger">*</span></label>
                                    <select class="form-select bg-light" name="gender" style="pointer-events: none;"
                                        required>
                                        <option value="MALE">Nam</option>
                                        <option value="FEMALE">Nữ</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn giới tính.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Ngày sinh <span class="text-danger">*</span></label>
                                    <input type="date" class="form-control bg-light" name="dateOfBirth" readonly
                                        required>
                                    <div class="invalid-feedback">Vui lòng nhập ngày sinh.</div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Dân tộc</label>
                                    <input type="text" class="form-control bg-light" name="ethnicity" value="Kinh"
                                        readonly>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Nơi thường trú cuối cùng <span
                                            class="text-danger">*</span></label>
                                    <input type="text" class="form-control bg-light" name="lastResidence"
                                        placeholder="VD: Tổ 5, Phường Hòa Hiệp Bắc, Liên Chiểu, Đà Nẵng" readonly
                                        required>
                                    <div class="invalid-feedback">Vui lòng nhập nơi thường trú cuối cùng.</div>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Số GCN báo tử / Giấy tờ thay thế</label>
                                    <input type="text" class="form-control" name="deathNoticeNumber"
                                        placeholder="Số hiệu giấy báo tử...">
                                </div>
                            </div>

                            <h6 class="fw-bold text-uppercase mt-4 mb-3 text-secondary">B. Thông tin về Cái chết</h6>
                            <div class="row g-3">
                                <div class="col-md-8">
                                    <label class="form-label">Ngày & Giờ chết <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" name="dateOfDeath" required
                                        onchange="checkOverdue()">
                                    <div id="overdueWarning" class="alert alert-warning mt-2 d-none small">
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                        <strong>Đăng ký quá hạn (trên 15 ngày)!</strong><br>
                                        Thủ tục sẽ chuyển sang quy trình thẩm tra chặt chẽ hơn. Vui lòng cung cấp thêm
                                        giấy tờ chứng minh ở Bước 3.
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Nơi chết <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" name="placeOfDeath"
                                        placeholder="Tại nhà / Bệnh viện / Khác..." required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Nguyên nhân chết</label>
                                    <input type="text" class="form-control" name="deathReason"
                                        placeholder="VD: Bệnh già, Bệnh lý...">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: UPLOAD ZONE -->
                    <div id="step3" class="d-none">
                        <h5 class="fw-bold border-bottom pb-2 mb-4 text-primary">Bước 3: Thành phần Hồ sơ</h5>

                        <div class="alert alert-info border-0 shadow-sm-soft mb-4">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Vui lòng đính kèm bản scan hoặc ảnh chụp rõ nét của các giấy tờ sau.
                        </div>

                        <!-- 1. GIAY BAO TU -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">1. Giấy báo tử hoặc giấy tờ thay thế <span
                                    class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="file" class="form-control" name="file_giay_bao_tu"
                                    accept=".pdf,.jpg,.jpeg,.png" required onchange="validateFileSize(this)">
                            </div>
                            <div class="form-text">Bản chính hoặc bản sao điện tử có giá trị pháp lý.</div>
                        </div>

                        <!-- 2. GIAY TO KHAC -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">2. Giấy tờ khác (CMND/CCCD người mất, Sổ hộ
                                khẩu...)</label>
                            <input type="file" class="form-control" name="file_khac" multiple
                                accept=".pdf,.jpg,.jpeg,.png" onchange="validateFileSize(this)">
                            <div class="form-text">Có thể chọn nhiều file.</div>
                        </div>

                        <!-- 3. BANG CHUNG KHAC (FOR OVERDUE) -->
                        <div id="overdueEvidenceSection" class="mb-4 d-none">
                            <label class="form-label fw-bold text-warning">3. Bằng chứng chứng minh sự kiện chết (Do
                                đăng ký quá hạn) <span class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="file" class="form-control" name="file_bang_chung_chet" multiple
                                    accept=".pdf,.jpg,.jpeg,.png" onchange="validateFileSize(this)">
                            </div>
                            <div class="form-text">Bắt buộc: Biên bản xác nhận của người làm chứng, xác nhận của UBND
                                hoặc cơ quan công an...</div>
                        </div>

                        <!-- COMMITMENT -->
                        <div class="form-check mt-4 p-3 rounded-3 bg-light border">
                            <input class="form-check-input" type="checkbox" id="commitmentCheck" required
                                style="transform: scale(1.2); margin-top: 0.25rem;">
                            <label class="form-check-label ms-2 fw-bold text-primary" for="commitmentCheck">
                                Tôi cam kết thông tin kê khai và tài liệu đính kèm là đúng sự thật. Tôi chịu hoàn toàn
                                trách nhiệm trước pháp luật về tính chính xác, trung thực của hồ sơ.
                            </label>
                        </div>
                    </div>

                    <!-- STEP 4: PAYMENT & SUBMIT -->
                    <div id="step4" class="d-none">
                        <h5 class="fw-bold border-bottom pb-2 mb-4 text-primary">Bước 4: Xác nhận & Nộp hồ sơ</h5>

                        <div class="alert alert-success border-0 shadow-sm text-center py-4">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                            <h4 class="fw-bold mt-3">Hồ sơ đã sẵn sàng!</h4>
                            <p class="text-muted">Vui lòng kiểm tra lại thông tin trước khi nộp.</p>
                        </div>

                        <div class="bg-white p-3 border rounded mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span class="fw-bold">Lệ phí thủ tục:</span>
                                <span>0 VNĐ <span class="badge bg-success">Miễn phí</span></span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Phí cấp bản sao (2 bản):</span>
                                <span class="fw-bold">16,000 VNĐ</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fs-5 fw-bold text-primary">
                                <span>Tổng cộng:</span>
                                <span>16,000 VNĐ</span>
                            </div>
                        </div>

                        <p class="text-center small text-muted">
                            Bằng việc nhấn "Nộp hồ sơ", bạn cam kết chịu trách nhiệm về tính chính xác của thông tin.
                        </p>

                    </div>

                    <!-- ACTION BUTTONS -->
                    <div class="d-flex justify-content-between mt-5 pt-3 border-top">
                        <button class="btn btn-secondary px-4 disabled" id="btnBack" type="button"
                            onclick="changeStep(-1)">
                            <i class="bi bi-arrow-left me-2"></i>Quay lại
                        </button>
                        <button class="btn btn-primary px-4 fw-bold" id="btnNext" type="button" onclick="changeStep(1)">
                            Tiếp tục <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>

            </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="bg-footer-dark text-white py-5 mt-auto">
        <div class="container">
            <div class="row g-4">
                <div class="col-md-5">
                    <h5 class="fw-bold mb-4 text-uppercase text-white-50 small ls-1">Đơn vị vận hành</h5>
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-building fs-1 me-3 opacity-50"></i>
                        <div>
                            <h6 class="fw-bold mb-1">TRUNG TÂM HÀNH CHÍNH CÔNG</h6>
                            <p class="mb-0 small opacity-75">Thành phố Đà Nẵng</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 offset-md-1">
                    <h5 class="fw-bold mb-4 text-uppercase text-white-50 small ls-1">Liên kết</h5>
                    <ul class="list-unstyled small opacity-75 d-flex flex-column gap-2">
                        <li><a href="#" class="text-white text-decoration-none hover-white"><i
                                    class="bi bi-chevron-right me-2"></i>Cổng thông tin Tp.</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5 class="fw-bold mb-4 text-uppercase text-white-50 small ls-1">Liên hệ</h5>
                    <p class="small opacity-75 mb-1"><i class="bi bi-geo-alt me-2"></i>24 Trần Phú, Hải Châu</p>
                    <p class="small opacity-75 mb-1"><i class="bi bi-telephone me-2"></i>(0236) 1022</p>
                </div>
            </div>
            <hr class="opacity-10 my-4">
            <div class="text-center small opacity-50">
                &copy; 2025 E-Gov Simulation System (Static Prototype Mode)
            </div>
        </div>
    </footer>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmSubmitModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-primary">Xác nhận nộp hồ sơ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-question-circle-fill text-warning display-4 mb-3"></i>
                    <h5 class="fw-bold">Xác nhận nộp hồ sơ?</h5>

                    <!-- SUMMARY CONTENT -->
                    <div id="modalSummaryContent" class="text-start bg-light p-3 rounded border mt-3 small">
                        <!-- Filled by JS -->
                    </div>

                    <p class="text-muted small mt-3 mb-0">Vui lòng kiểm tra kỹ thông tin trước khi xác nhận.</p>
                </div>
                <div class="modal-footer border-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Xem lại</button>
                    <button type="button" class="btn btn-primary px-4 fw-bold" onclick="onModalConfirm()">
                        <i class="bi bi-check-circle me-2"></i>Đồng ý nộp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;

        // Toast Helper
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            let bgClass = 'bg-primary';
            let icon = 'bi-info-circle';

            if (type === 'success') {
                bgClass = 'bg-success';
                icon = 'bi-check-circle-fill';
            } else if (type === 'error' || type === 'danger') {
                bgClass = 'bg-danger';
                icon = 'bi-exclamation-triangle-fill';
            } else if (type === 'warning') {
                bgClass = 'bg-warning text-dark';
                icon = 'bi-exclamation-circle-fill';
            }

            const html = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body d-flex align-items-center">
                            <i class="bi ${icon} fs-5 me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', html);
            const toastEl = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastEl, { delay: 5000 });
            bsToast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        // ON LOAD: Auto-fill Applicant Info
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch('/api/autofill/me');
                if (response.ok) {
                    const data = await response.json();
                    // Fill Applicant Info
                    document.querySelector('input[name="relativeFullName"]').value = data.fullName || '';
                    document.querySelector('input[name="relativeDateOfBirth"]').value = data.dob ? new Date(data.dob).toLocaleDateString('en-GB') : '';
                    document.querySelector('input[name="relativePhoneNumber"]').value = data.phoneNumber || '';
                    document.querySelector('input[name="relativeAddress"]').value = data.permanentAddress || '';

                    // Fill ID if exists
                    const cccdInput = document.getElementById('searchCccdApplicant');
                    if (cccdInput) cccdInput.value = data.cccd || '';
                }
            } catch (e) {
                console.error("User not logged in or auto-fill failed", e);
            }
        });

        // NAVIGATION LOGIC
        function changeStep(n) {
            // Validate if moving to next step
            if (n > 0 && !validateStep(currentStep)) {
                return;
            }

            currentStep += n;
            if (currentStep < 1) currentStep = 1;
            if (currentStep > 4) currentStep = 4;
            updateWizardUI();
        }

        // Helper to validate file size
        function validateFileSize(input) {
            if (input.files && input.files.length > 0) {
                const maxSize = 10 * 1024 * 1024; // 10MB
                for (let i = 0; i < input.files.length; i++) {
                    if (input.files[i].size > maxSize) {
                        showToast(`File ${input.files[i].name} vượt quá 10MB!`, 'warning');
                        input.value = ''; // Clear input
                        return false;
                    }
                }
            }
        }

        function validateStep(step) {
            const stepEl = document.getElementById(`step${step}`);
            if (!stepEl) return true;

            let isValid = true;

            // Reset validations
            stepEl.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

            // --- New relationship check for Step 2 ---
            if (step === 2) {
                const deceasedId = document.getElementById('searchCccdDeceased').value;
                const isValidRelation = document.getElementById('isRelationValid').value;

                if (!deceasedId) {
                    isValid = false;
                    showToast("Vui lòng nhập và tra cứu thông tin Công dân (Người mất).", 'warning');
                } else if (isValidRelation === "false") {
                    isValid = false;
                    // Requirement: "phải có mối quan hệ" -> Strict
                    showToast("Bắt buộc: Người đi khai phải có mối quan hệ (Cùng hộ khẩu hoặc trong phạm vi 3 đời) với Người mất", 'error');
                }
            }
            // --- End new relationship check ---

            // --- Validation for Step 3: Specific Files ---
            if (step === 3) {
                const fileGiayBaoTu = document.querySelector('input[name="file_giay_bao_tu"]');
                if (fileGiayBaoTu && fileGiayBaoTu.files.length === 0) {
                    fileGiayBaoTu.classList.add('is-invalid');
                    showToast("Vui lòng đính kèm Giấy báo tử!", 'warning');
                    isValid = false;
                } else {
                    if (fileGiayBaoTu) fileGiayBaoTu.classList.remove('is-invalid');
                }

                const commitment = document.getElementById('commitmentCheck');
                if (!commitment.checked) {
                    commitment.classList.add('is-invalid');
                    showToast("Bạn chưa cam kết thông tin!", 'warning');
                    isValid = false;
                } else {
                    commitment.classList.remove('is-invalid');
                }

                // Validate Overdue Evidence
                const isOnTime = document.getElementById('isOnTime').value === "true";
                if (!isOnTime) {
                    const evidenceInput = document.querySelector('input[name="file_bang_chung_chet"]');
                    if (evidenceInput && evidenceInput.files.length === 0) {
                        evidenceInput.classList.add('is-invalid');
                        showToast("Đăng ký quá hạn: Vui lòng cung cấp bằng chứng chứng minh sự kiện chết!", 'warning');
                        isValid = false;
                    } else {
                        if (evidenceInput) evidenceInput.classList.remove('is-invalid');
                    }
                }
            }


            const inputs = stepEl.querySelectorAll('input[required], select[required], textarea[required]');
            for (let input of inputs) {
                // Check validity (HTML5)
                if (!input.checkValidity() || !input.value.trim()) {
                    input.classList.add('is-invalid');
                    if (isValid) {
                        input.focus(); // Focus first invalid
                        isValid = false;
                    }
                } else {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                }
            }

            // Step 2 Logic Validation: Dates
            if (step === 2) {
                const dobInput = document.querySelector('input[name="dateOfBirth"]');
                const dodInput = document.querySelector('input[name="dateOfDeath"]');
                const dob = new Date(dobInput.value + 'T00:00');
                const dod = new Date(dodInput.value);
                const today = new Date();

                if (dod > today) {
                    dodInput.classList.add('is-invalid');
                    showToast("Ngày chết không thể ở tương lai!", 'warning');
                    isValid = false;
                }

                if (dob > today) {
                    dobInput.classList.add('is-invalid');
                    showToast("Ngày sinh không thể ở tương lai!", 'warning');
                    isValid = false;
                }

                if (dod <= dob) {
                    dodInput.classList.add('is-invalid');
                    showToast("Ngày chết phải sau ngày sinh!", 'warning');
                    isValid = false;
                }

                checkOverdue(); // Double check logic
            }

            return isValid;
        }

        function updateWizardUI() {
            // 1. Show/Hide Content Sections
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`step${i}`);
                const navEl = document.getElementById(`navStep${i}`);
                if (i === currentStep) {
                    el.classList.remove('d-none');
                    navEl.classList.add('active');
                    navEl.querySelector('.btn-circle').classList.remove('text-muted');
                    navEl.querySelector('small').classList.remove('text-muted');
                    navEl.querySelector('small').classList.add('fw-bold');
                } else {
                    el.classList.add('d-none');
                    navEl.classList.remove('active');
                    if (i < currentStep) {
                        navEl.classList.add('text-success');
                    }
                }
            }

            // 2. Button State
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');

            if (currentStep === 1) {
                btnBack.classList.add('disabled');
            } else {
                btnBack.classList.remove('disabled');
            }

            if (currentStep === 4) {
                btnNext.innerHTML = '<i class="bi bi-send-fill me-2"></i>Nộp hồ sơ';
                btnNext.classList.remove('btn-primary');
                btnNext.classList.add('btn-success');
                btnNext.onclick = function () {
                    showConfirmModal();
                };
            } else {
                btnNext.innerHTML = 'Tiếp tục <i class="bi bi-arrow-right ms-2"></i>';
                btnNext.classList.add('btn-primary');
                btnNext.classList.remove('btn-success');
                btnNext.onclick = function () { changeStep(1); };
            }
        }

        // --- CITIZEN AUTO-FILL ---
        // Shared function to fetch citizen data
        async function fetchCitizenData(cccd) {
            try {
                const response = await fetch(`/api/autofill/citizen/${cccd}`);
                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error("Lỗi khi gọi API:", error);
                return null;
            }
        }

        // Check relationship with deceased
        async function checkRelationship(deceasedCccd) {
            const resultDiv = document.getElementById('relationCheckResult');
            const isValidInput = document.getElementById('isRelationValid');

            resultDiv.innerHTML = '<span class="text-primary"><i class="bi bi-hourglass-split"></i> Đang kiểm tra mối quan hệ...</span>';

            try {
                const response = await fetch(`/api/autofill/relation?targetCccd=${deceasedCccd}`);
                if (response.ok) {
                    const result = await response.json();
                    if (result.valid) {
                        resultDiv.innerHTML = `<span class="text-success fw-bold"><i class="bi bi-check-circle-fill"></i> Xác thực quan hệ: ${result.detail} (${result.authorizedPersonName})</span>`;
                        isValidInput.value = "true";
                    } else {
                        resultDiv.innerHTML = `<span class="text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill"></i> Cảnh báo: ${result.message}</span>`;
                        isValidInput.value = "false";
                    }
                } else {
                    resultDiv.innerHTML = '<span class="text-warning">Không thể kiểm tra mối quan hệ lúc này.</span>';
                    isValidInput.value = "true"; // Allow manual bypass if API fails? Strict: "false"
                }
            } catch (error) {
                console.error("Check relation error:", error);
                resultDiv.innerHTML = '';
            }
        }

        async function autoFillDeceased() {
            const cccdInput = document.getElementById("searchCccdDeceased");
            const cccd = cccdInput.value;
            const deceasedIdInput = document.getElementById("deceasedIdNumber");

            if (!cccd || cccd.length !== 12) {
                showToast("Vui lòng nhập số CCCD hợp lệ (12 số).", 'warning');
                return;
            }

            // CHECK: Cannot declare oneself as deceased
            const applicantCccd = document.getElementById('searchCccdApplicant').value.trim();
            if (cccd === applicantCccd) {
                showToast("Không thể đăng ký khai tử cho chính mình (CCCD trùng với người đi khai).", 'error');
                cccdInput.value = '';
                return;
            }

            const data = await fetchCitizenData(cccd);

            if (data) {
                // NEW VALIDATION: Check if citizen is already deceased
                if (data.isDeceased) {
                    showToast("Cảnh báo: Công dân này đã có trạng thái 'Đã mất' trên hệ thống CSDL. Không thể thực hiện đăng ký khai tử.", 'error');

                    // Clear fields if they were previously filled or ensure they are empty
                    document.querySelector('[name="deceasedFullName"]').value = '';
                    document.querySelector('[name="gender"]').value = 'MALE';
                    document.querySelector('[name="dateOfBirth"]').value = '';
                    document.querySelector('[name="ethnicity"]').value = 'Kinh';
                    document.querySelector('[name="lastResidence"]').value = '';
                    if (deceasedIdInput) deceasedIdInput.value = '';

                    document.getElementById('relationCheckResult').innerHTML = '';
                    document.getElementById('isRelationValid').value = "false";
                    return;
                }

                // Fill fields
                document.querySelector('[name="deceasedFullName"]').value = data.fullName || '';
                document.querySelector('[name="gender"]').value = data.gender || 'MALE';
                document.querySelector('[name="dateOfBirth"]').value = data.dob || '';
                document.querySelector('[name="ethnicity"]').value = data.ethnicGroup || 'Kinh';
                document.querySelector('[name="lastResidence"]').value = data.permanentAddress || '';

                // Set Hidden ID
                if (deceasedIdInput) deceasedIdInput.value = cccd;

                // Trigger Validation Check
                checkRelationship(cccd);

                // Toast
                const toast = document.createElement('div');
                toast.className = 'position-fixed bottom-0 end-0 p-3';
                toast.style.zIndex = '1100';
                toast.innerHTML = `
            <div class="toast show align-items-center text-white bg-success border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="bi bi-check-circle me-2"></i>Đã tìm thấy thông tin công dân!
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>`;
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);

            } else {
                showToast("Không tìm thấy thông tin công dân với CCCD này trong CSDL.", 'error');
                // Reset validation if not found
                document.getElementById('relationCheckResult').innerHTML = '';
                document.getElementById('isRelationValid').value = "false";
            }
        }

        async function autoFillApplicant() {
            const input = document.getElementById('searchCccdApplicant');
            const data = await fetchCitizenData(input.value.trim());

            input.classList.toggle('is-valid', !!data);
            input.classList.toggle('is-invalid', !data);

            if (data) {
                document.querySelector('input[name="relativeFullName"]').value = data.fullName || '';
                document.querySelector('input[name="relativeDateOfBirth"]').value = data.dob ? new Date(data.dob).toLocaleDateString('en-GB') : '';
                document.querySelector('input[name="relativePhoneNumber"]').value = data.phoneNumber || '';
                document.querySelector('input[name="relativeAddress"]').value = data.permanentAddress || '';
            }
        }

        // CONFIRMATION MODAL LOGIC
        function showConfirmModal() {
            // 1. Get Values
            const applicantName = document.querySelector('input[name="relativeFullName"]').value || '---';
            const applicantId = document.querySelector('input[name="relativeIdNumber"]').value || '---';
            const deceasedName = document.querySelector('input[name="deceasedFullName"]').value || '---';
            const deathDateTimeValue = document.querySelector('input[name="dateOfDeath"]').value;

            // 2. Get Files from Inputs
            let fileListHtml = '<ul class="ps-3 mb-0">';
            let hasFiles = false;
            const fileInputs = document.querySelectorAll('input[type="file"]');

            fileInputs.forEach(input => {
                if (input.files.length > 0) {
                    hasFiles = true;
                    Array.from(input.files).forEach(f => {
                        fileListHtml += `<li>${f.name} <span class="text-muted">(${(f.size / 1024 / 1024).toFixed(2)} MB)</span></li>`;
                    });
                }
            });

            if (!hasFiles) {
                fileListHtml += '<li class="text-danger fst-italic">Chưa có tệp đính kèm</li>';
            }
            fileListHtml += '</ul>';

            // 3. Construct HTML
            const summaryHtml = `
                <table class="table table-sm table-borderless mb-0">
                    <tr>
                        <td class="fw-bold text-nowrap" style="width: 140px;">Người đi khai:</td>
                        <td>${applicantName} <br><small class="text-muted">(CCCD: ${applicantId})</small></td>
                    </tr>
                    <tr>
                        <td class="fw-bold text-nowrap">Người mất:</td>
                        <td class="text-uppercase text-danger fw-bold">${deceasedName}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold text-nowrap">Thời gian mất:</td>
                        <td>${deathDateTimeValue ? new Date(deathDateTimeValue).toLocaleString('vi-VN') : '---'}</td>
                    </tr>
                    <tr>
                        <td class="fw-bold text-nowrap align-top">Tài liệu:</td>
                        <td>${fileListHtml}</td>
                    </tr>
                </table>
            `;

            // 4. Inject
            document.getElementById('modalSummaryContent').innerHTML = summaryHtml;

            const modal = new bootstrap.Modal(document.getElementById('confirmSubmitModal'));
            modal.show();
        }

        function onModalConfirm() {
            const modalEl = document.getElementById('confirmSubmitModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
            submitDossier();
        }

        async function submitDossier() {
            const btnNext = document.getElementById('btnNext');
            const originalText = btnNext.innerHTML;
            btnNext.disabled = true;
            btnNext.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Đang xử lý...';

            try {
                const form = document.getElementById('submissionForm');
                const formData = new FormData(form);

                // IMPORTANT: Append all files to 'files' key
                const fileInputs = form.querySelectorAll('input[type="file"]');
                fileInputs.forEach(input => {
                    if (input.files.length > 0) {
                        for (let i = 0; i < input.files.length; i++) {
                            formData.append('files', input.files[i]);
                        }
                    }
                });

                // Ensure boolean isOnTime is sent correctly (if form logic doesn't cover)
                // formData already includes inputs, so isOnTime hidden input is included.

                const response = await fetch('/citizen/submit', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.status === 'success') {
                    window.location.href = '/citizen/hoso';
                } else {
                    showToast("Lỗi nộp hồ sơ: " + (result.message || 'Không rõ nguyên nhân'), 'error');
                    btnNext.disabled = false;
                    btnNext.innerHTML = originalText;
                }
            } catch (error) {
                console.error('Submission error:', error);
                showToast("Đã xảy ra lỗi khi gửi hồ sơ. Vui lòng thử lại sau.", 'error');
                btnNext.disabled = false;
                btnNext.innerHTML = originalText;
            }
        }

        function checkOverdue() {
            const dodInput = document.querySelector('input[name="dateOfDeath"]');
            if (!dodInput.value) return;

            const dod = new Date(dodInput.value);
            const today = new Date();

            // Calculate difference in days
            const diffTime = Math.abs(today - dod);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            // Note: If death is today, diffDays might be 0 or small. 
            // If death was 20 days ago, diffDays ~ 20.

            const warningEl = document.getElementById('overdueWarning');
            const isOnTimeInput = document.getElementById('isOnTime');
            const evidenceSection = document.getElementById('overdueEvidenceSection');

            if (diffDays > 15 && dod < today) {
                // Overdue
                warningEl.classList.remove('d-none');
                evidenceSection.classList.remove('d-none');
                isOnTimeInput.value = "false";

                // Add required attribute to logic check
            } else {
                // On time
                warningEl.classList.add('d-none');
                evidenceSection.classList.add('d-none');
                isOnTimeInput.value = "true";
            }
        }
    </script>
</body>

</html>