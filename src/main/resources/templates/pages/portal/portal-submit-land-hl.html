<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nộp Hồ sơ: Biến động Đất đai - Dịch vụ công Đà Nẵng</title>
    <!-- Core CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" th:href="@{/assets/css/style.css}">
    <link rel="stylesheet" th:href="@{/assets/css/portal.css}">
    <style>
        .wizard-step {
            position: relative;
            z-index: 1;
        }

        .wizard-step .btn-circle {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            background: white;
            font-weight: bold;
            color: #6c757d;
        }

        .wizard-step.active .btn-circle {
            border-color: var(--bs-primary);
            background: var(--bs-primary);
            color: white;
        }

        .wizard-connector {
            position: absolute;
            top: 20px;
            left: 0;
            width: 100%;
            height: 2px;
            background: #dee2e6;
            z-index: 0;
        }
    </style>
</head>

<body class="bg-light">

    <!-- 1. HEADER -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm-soft py-3 bg-gradient-primary">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center fw-bold fs-4" th:href="@{/citizen/portal}">
                <i class="bi bi-bank2 me-2"></i>DỊCH VỤ CÔNG ĐÀ NẴNG
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#landingNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="landingNav">
                <ul class="navbar-nav ms-auto gap-3 mb-2 mb-lg-0">
                    <li class="nav-item"><a class="nav-link fw-medium text-white-50 hover-white"
                            th:href="@{/citizen/portal}">Trang chủ</a></li>
                    <li class="nav-item"><a class="nav-link fw-medium text-white-50 hover-white"
                            th:href="@{/citizen/services}">Dịch vụ công</a></li>
                    <li class="nav-item"><a class="nav-link fw-medium text-white-50 hover-white" href="#">Hướng dẫn</a>
                    </li>
                    <li class="nav-item"><a class="nav-link fw-medium text-white-50 hover-white"
                            th:href="@{/citizen/feedback}">Phản ánh kiến nghị</a></li>
                </ul>
                <div class="ms-lg-4">
                    <!-- User Profile -->
                    <div class="dropdown">
                        <a href="#" class="d-flex align-items-center text-white text-decoration-none dropdown-toggle"
                            data-bs-toggle="dropdown">
                            <img th:src="'https://ui-avatars.com/api/?name=' + ${#authentication.principal.fullName} + '&background=random'"
                                class="rounded-circle me-2" width="32">
                            <span th:text="${#authentication.principal.fullName}">Lê Văn Dân</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end shadow-sm">
                            <li><a class="dropdown-item" th:href="@{/citizen/profile}"><i
                                        class="bi bi-person me-2"></i>Thông tin cá nhân</a></li>
                            <li><a class="dropdown-item" th:href="@{/citizen/vault}"><i class="bi bi-safe me-2"></i>Kho
                                    dữ
                                    liệu số</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item text-danger" th:href="@{/logout/citizen}"><i
                                        class="bi bi-box-arrow-right me-2"></i>Đăng xuất</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- MAIN CONTENT -->
    <main class="container mt-5 pt-5 mb-5">

        <!-- Page Title -->
        <div class="text-center mb-5">
            <h2 class="fw-bold text-primary mb-2">Nộp Hồ sơ Trực tuyến</h2>
            <p class="text-muted fs-5">Thủ tục: <strong>Đăng ký biến động đất đai</strong></p>
        </div>

        <!-- 2. WIZARD NAV -->
        <div class="position-relative mb-5 mx-auto" style="max-width: 800px;">
            <!-- Toast Container -->
            <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;"></div>

            <div class="wizard-connector"></div>
            <div class="d-flex justify-content-between position-relative">

                <div class="wizard-step active" id="navStep1">
                    <div class="text-center">
                        <div class="btn-circle mx-auto mb-2">1</div>
                        <small class="fw-bold">Chủ sở hữu</small>
                    </div>
                </div>

                <div class="wizard-step" id="navStep2">
                    <div class="text-center">
                        <div class="btn-circle mx-auto mb-2">2</div>
                        <small class="text-muted">Chọn Tài sản</small>
                    </div>
                </div>

                <div class="wizard-step" id="navStep3">
                    <div class="text-center">
                        <div class="btn-circle mx-auto mb-2">3</div>
                        <small class="text-muted">Thành phần Hồ sơ</small>
                    </div>
                </div>

                <div class="wizard-step" id="navStep4">
                    <div class="text-center">
                        <div class="btn-circle mx-auto mb-2">4</div>
                        <small class="text-muted">Lệ phí & Nộp</small>
                    </div>
                </div>

            </div>
        </div>

        <!-- WIZARD CONTENT -->
        <div class="card shadow-sm border-0 rounded-3 wizard-content mx-auto" style="max-width: 900px;">
            <div class="card-body p-4 p-lg-5">

                <form id="submissionForm" enctype="multipart/form-data">
                    <input type="hidden" name="serviceCode" th:value="${serviceCode}">
                    <!-- Step 1: Current Owner Info -->
                    <div id="step1">

                        <!-- AUTHORIZATION SECTION -->
                        <div class="card mb-4 border shadow-sm-soft">
                            <div class="card-body">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="authToggle" name="isAuthorized"
                                        onchange="toggleAuthorization()" style="cursor: pointer;">
                                    <label class="form-check-label fw-bold " for="authToggle"
                                        style="cursor: pointer;">Tôi
                                        nộp hồ sơ thay cho người khác (Được ủy quyền)</label>
                                </div>

                                <div id="authSection"
                                    class="d-none mt-3 ps-4 border-start border-3 border-primary animate-fade-in">
                                    <div class="mb-3">
                                        <label class="form-label text-muted small text-uppercase fw-bold">Nhập Số CCCD
                                            người
                                            ủy quyền</label>
                                        <div class="input-group" style="max-width: 450px;">
                                            <input type="text" class="form-control form-control-lg bg-light"
                                                id="authorizerCccd" name="authorizerCccd" placeholder="00123456789">
                                            <button class="btn btn-outline-primary px-4" type="button"
                                                onclick="checkAuthorizer()">
                                                <i class="bi bi-search me-1"></i> Tra cứu
                                            </button>
                                            <div class="invalid-feedback">Vui lòng nhập số CCCD hợp lệ và thực hiện tra
                                                cứu.
                                            </div>
                                        </div>
                                    </div>

                                    <div id="authResult" class="d-none mb-2"></div>

                                    <div class="small text-muted fst-italic">
                                        <i class="bi bi-exclamation-circle me-1"></i> Yêu cầu đính kèm Giấy ủy quyền hợp
                                        pháp ở Bước 3.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- SUBMITTER INFO SECTION (Visible only when Authorized) -->
                        <div id="submitterInfoSection" class="d-none mb-4 animate-fade-in">
                            <h6 class="text-secondary fw-bold text-uppercase border-bottom pb-2 mb-3">
                                <i class="bi bi-person-badge-fill me-2"></i>Thông tin người nộp thay (Bạn)
                            </h6>
                            <div class="card bg-light-info border-info border-opacity-25 shadow-sm-soft">
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label small text-muted text-uppercase fw-bold">Họ và
                                                tên</label>
                                            <input type="text" class="form-control bg-white" id="submitterName"
                                                readonly>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small text-muted text-uppercase fw-bold">Số
                                                CCCD</label>
                                            <input type="text" class="form-control bg-white" id="submitterCccd"
                                                readonly>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label small text-muted text-uppercase fw-bold">Địa
                                                chỉ</label>
                                            <input type="text" class="form-control bg-white" id="submitterAddress"
                                                readonly>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label text-muted small text-uppercase fw-bold">Chủ sở hữu hiện
                                    tại</label>
                                <input type="text" class="form-control bg-light fw-bold text-primary"
                                    name="currentOwner" th:value="${opsDossier.formData['currentOwner']}" readonly
                                    required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small text-uppercase fw-bold">Số CCCD/Định
                                    danh</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" name="ownerIdNumber" id="searchCccdOwner"
                                        th:value="${opsDossier.formData['ownerIdNumber']}" placeholder="Nhập số CCCD..."
                                        readonly required>
                                    <button class="btn btn-outline-secondary" type="button" disabled>
                                        <i class="bi bi-lock-fill"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-12">
                                <label class="form-label text-muted small text-uppercase fw-bold">Địa chỉ thường
                                    trú</label>
                                <input type="text" class="form-control bg-light" name="ownerAddress"
                                    th:value="${opsDossier.formData['ownerAddress']}" readonly required>
                            </div>
                            <div class="col-12">
                                <label class="form-label text-muted small text-uppercase fw-bold">Nơi nộp hồ sơ</label>
                                <select class="form-select" name="receivingDeptId" required>
                                    <option value="">-- Chọn Đơn vị tiếp nhận --</option>
                                    <option th:each="dept : ${sysDepartment}" th:value="${dept.id}"
                                        th:text="${dept.deptName}"></option>
                                </select>
                            </div>
                        </div>

                    </div>

                    <!-- STEP 2: LAND ASSET FORM -->
                    <div id="step2" class="d-none">
                        <h5 class="fw-bold border-bottom pb-2 mb-4 text-primary">Bước 2: Chọn Tài sản & Loại biến động
                        </h5>

                        <div id="formLand">
                            <h6 class="fw-bold text-uppercase mb-3 text-secondary">A. Thông tin thửa đất</h6>

                            <!-- Hidden fields for the selected land asset (Defaulting to the checked one) -->
                            <input type="hidden" name="landCertificateNumber">
                            <input type="hidden" name="landPlotNumber">
                            <input type="hidden" name="landMapSheet">
                            <input type="hidden" name="landAddress">
                            <input type="hidden" name="landArea">
                            <input type="hidden" name="landUseType">
                            <input type="hidden" name="landPurpose">

                            <!-- Asset Selector -->
                            <div class="row row-cols-1 row-cols-md-2 g-4 mb-4" id="landAssetList">
                                <!-- Assets will be loaded via API -->
                                <div class="col-12 text-center py-5 text-muted">
                                    <div class="spinner-border text-primary" role="status"></div>
                                    <p class="mt-2 small">Đang tải dữ liệu đất đai...</p>
                                </div>
                            </div>

                            <h6 class="fw-bold text-uppercase mt-4 mb-3 text-secondary">B. Thông tin biến động</h6>
                            <div class="row g-3">
                                <div class="col-12">
                                    <label class="form-label">Loại biến động <span class="text-danger">*</span></label>
                                    <select class="form-select" name="changeType" required>
                                        <option value="">-- Chọn loại biến động --</option>
                                        <option value="CN">Chuyển nhượng QSDĐ (Bán đất)</option>
                                        <option value="TC">Tặng cho QSDĐ</option>
                                        <option value="TK">Thừa kế QSDĐ</option>
                                        <option value="DT">Đổi tên người sử dụng đất</option>
                                    </select>
                                    <div class="invalid-feedback">Vui lòng chọn loại biến động.</div>
                                </div>

                                <div class="col-12">
                                    <label class="form-label">Lý do biến động <span class="text-danger">*</span></label>
                                    <textarea class="form-control" name="changeReason" rows="2"
                                        placeholder="VD: Chuyển nhượng toàn bộ thửa đất cho ông Nguyễn Văn B..."
                                        required></textarea>
                                    <div class="invalid-feedback">Vui lòng nhập lý do biến động.</div>
                                </div>

                                <!-- NEW OWNER AUTO-FILL -->
                                <div class="col-12">
                                    <label class="form-label text-primary fw-bold">Chủ sở hữu mới</label>
                                    <div class="card bg-light border-0">
                                        <div class="card-body">
                                            <div class="row g-3">
                                                <div class="col-md-5">
                                                    <label class="form-label small">Số CCCD/Định danh <span
                                                            class="text-danger">*</span></label>
                                                    <div class="input-group">
                                                        <input type="text" class="form-control" id="newOwnerCccd"
                                                            name="newOwnerCccd" placeholder="Nhập CCCD...">
                                                        <button class="btn btn-primary" type="button"
                                                            onclick="autoFillNewOwner()">
                                                            <i class="bi bi-search"></i>
                                                        </button>
                                                        <div class="invalid-feedback">Không tìm thấy công dân hoặc CCCD
                                                            không hợp lệ.</div>
                                                    </div>
                                                </div>
                                                <div class="col-md-7">
                                                    <label class="form-label small">Họ và tên chủ mới</label>
                                                    <!-- name="newOwner" maps to schema field -->
                                                    <input type="text" class="form-control fw-bold text-primary"
                                                        name="newOwner" id="newOwnerName" readonly required>
                                                </div>
                                                <div class="col-12">
                                                    <label class="form-label small">Địa chỉ thường trú</label>
                                                    <input type="text" class="form-control bg-white"
                                                        id="newOwnerAddress" name="newOwnerAddress" readonly>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- STEP 3: UPLOAD ZONE -->
                    <div id="step3" class="d-none">
                        <h5 class="fw-bold border-bottom pb-2 mb-4 text-primary">Bước 3: Thành phần Hồ sơ</h5>

                        <div class="alert alert-info border-0 shadow-sm-soft mb-4">
                            <i class="bi bi-info-circle-fill me-2"></i>
                            Vui lòng đính kèm bản scan hoặc ảnh chụp rõ nét của các giấy tờ sau.
                        </div>

                        <!-- 1. DON DANG KY (Mau 09/OK) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">1. Đơn đăng ký biến động đất đai (Mẫu 09/ĐK) <span
                                    class="text-danger">*</span></label>
                            <div class="input-group">
                                <input type="file" class="form-control" name="file_don_dang_ky"
                                    accept=".pdf,.jpg,.jpeg,.png" required onchange="validateFileSize(this)">
                                <button class="btn btn-outline-secondary" type="button"
                                    onclick="window.open('/assets/forms/Mau-09-DK.pdf', '_blank')">
                                    <i class="bi bi-download me-1"></i>Tải mẫu
                                </button>
                            </div>
                            <div class="form-text">Bản chính hoặc bản sao điện tử có giá trị pháp lý.</div>
                        </div>

                        <!-- 2. HOP DONG CHUYEN NHUONG -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">2. Hợp đồng/Văn bản về chuyển quyền <span
                                    class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file_hop_dong" accept=".pdf,.jpg,.jpeg,.png"
                                required onchange="validateFileSize(this)">
                            <div class="form-text text-muted">Hợp đồng chuyển nhượng, tặng cho, văn bản thừa kế... đã
                                công chứng/chứng thực.</div>
                        </div>

                        <!-- 3. GIAY CHUNG NHAN (SO DO) -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">3. Giấy chứng nhận QSDĐ (Sổ đỏ) <span
                                    class="text-danger">*</span></label>
                            <input type="file" class="form-control" name="file_so_do" accept=".pdf,.jpg,.jpeg,.png"
                                required onchange="validateFileSize(this)">
                            <div class="form-text">Bản gốc GPCN đã cấp (Scan đầy đủ các trang).</div>
                        </div>

                        <!-- 4. GIAY TO KHAC -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">4. Giấy tờ khác (Tờ khai thuế, phí, lệ phí...)</label>
                            <input type="file" class="form-control" name="file_khac" multiple
                                accept=".pdf,.jpg,.jpeg,.png" onchange="validateFileSize(this)">
                            <div class="form-text">Có thể chọn nhiều file.</div>
                        </div>

                        <!-- AUTHORIZATION FILE (Conditional) -->
                        <div id="authFileItem"
                            class="mb-4 d-none animate-fade-in p-3 bg-light-warning rounded-3 border border-warning border-opacity-25">
                            <label class="form-label fw-bold text-dark">
                                <i class="bi bi-file-earmark-lock2-fill text-warning me-2"></i>5. Giấy ủy quyền / Minh
                                chứng quan hệ <span class="text-danger">*</span>
                            </label>
                            <input type="file" class="form-control" name="file_uy_quyen" id="fileUyQuyenInput"
                                accept=".pdf,.jpg,.jpeg,.png" onchange="validateFileSize(this)">
                            <div class="form-text text-dark opacity-75">Bắt buộc đối với trường hợp nộp thay (Được ủy
                                quyền).</div>
                        </div>

                        <!-- COMMITMENT -->
                        <div class="form-check mt-5 p-3 rounded-3 bg-light border">
                            <input class="form-check-input" type="checkbox" id="commitmentCheck" required
                                style="transform: scale(1.2); margin-top: 0.25rem;">
                            <label class="form-check-label ms-2" for="commitmentCheck">
                                Tôi cam kết thông tin kê khai và tài liệu đính kèm là đúng sự thật. Tôi chịu hoàn toàn
                                trách nhiệm trước pháp luật về tính chính xác, trung thực của hồ sơ.
                            </label>
                        </div>

                    </div>

                    <!-- STEP 4: PAYMENT & SUBMIT -->
                    <div id="step4" class="d-none">
                        <h5 class="fw-bold border-bottom pb-2 mb-4 text-primary">Bước 4: Xác nhận & Nộp hồ sơ</h5>

                        <div class="alert alert-success border-0 shadow-sm text-center py-4">
                            <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                            <h4 class="fw-bold mt-3">Hồ sơ đã sẵn sàng!</h4>
                            <p class="text-muted">Vui lòng kiểm tra lại thông tin trước khi nộp.</p>
                        </div>

                        <div class="bg-white p-3 border rounded mb-4">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Phí thẩm định:</span>
                                <span class="fw-bold">500,000 VNĐ</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Lệ phí cấp GCN:</span>
                                <span class="fw-bold">100,000 VNĐ</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Thuế TNCN & Trước bạ:</span>
                                <span class="fw-bold text-muted fw-normal">Chờ thông báo thuế (Sau Bước 2)</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between fs-5 fw-bold text-primary">
                                <span>Tạm thu:</span>
                                <span>600,000 VNĐ</span>
                            </div>
                        </div>

                        <p class="text-center small text-muted">
                            Bằng việc nhấn "Nộp hồ sơ", bạn cam kết chịu trách nhiệm về tính chính xác của thông tin.
                        </p>

                    </div>

                    <!-- ACTION BUTTONS -->
                    <div class="d-flex justify-content-between mt-5 pt-3 border-top">
                        <button class="btn btn-secondary px-4 disabled" id="btnBack" type="button"
                            onclick="changeStep(-1)">
                            <i class="bi bi-arrow-left me-2"></i>Quay lại
                        </button>
                        <button class="btn btn-primary px-4 fw-bold" id="btnNext" type="button" onclick="changeStep(1)">
                            Tiếp tục <i class="bi bi-arrow-right ms-2"></i>
                        </button>
                    </div>
                </form>
            </div>

        </div>
        </div>

    </main>

    <!-- FOOTER -->
    <footer class="bg-footer-dark text-white py-5 mt-auto">
        <div class="container">
            <div class="row g-4">
                <div class="col-md-5">
                    <h5 class="fw-bold mb-4 text-uppercase text-white-50 small ls-1">Đơn vị vận hành</h5>
                    <div class="d-flex align-items-center mb-3">
                        <i class="bi bi-building fs-1 me-3 opacity-50"></i>
                        <div>
                            <h6 class="fw-bold mb-1">TRUNG TÂM HÀNH CHÍNH CÔNG</h6>
                            <p class="mb-0 small opacity-75">Thành phố Đà Nẵng</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 offset-md-1">
                    <h5 class="fw-bold mb-4 text-uppercase text-white-50 small ls-1">Liên kết</h5>
                    <ul class="list-unstyled small opacity-75 d-flex flex-column gap-2">
                        <li><a href="#" class="text-white text-decoration-none hover-white"><i
                                    class="bi bi-chevron-right me-2"></i>Cổng thông tin Tp.</a></li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <h5 class="fw-bold mb-4 text-uppercase text-white-50 small ls-1">Liên hệ</h5>
                    <p class="small opacity-75 mb-1"><i class="bi bi-geo-alt me-2"></i>24 Trần Phú, Hải Châu</p>
                    <p class="small opacity-75 mb-1"><i class="bi bi-telephone me-2"></i>(0236) 1022</p>
                </div>
            </div>
            <hr class="opacity-10 my-4">
            <div class="text-center small opacity-50">
                &copy; 2025 E-Gov Simulation System (Static Prototype Mode)
            </div>
        </div>
    </footer>

    <!-- Confirmation Modal -->
    <div class="modal fade" id="confirmSubmitModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0 pb-0">
                    <h5 class="modal-title fw-bold text-primary">Xác nhận nộp hồ sơ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <i class="bi bi-question-circle-fill text-warning display-4 mb-3"></i>
                    <p class="mb-0 fs-5">Bạn có chắc chắn muốn nộp hồ sơ này không?</p>
                    <p class="text-muted small mt-2">Vui lòng kiểm tra kỹ thông tin trước khi xác nhận.</p>
                </div>
                <div class="modal-footer border-0 justify-content-center pb-4">
                    <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal">Xem lại</button>
                    <button type="button" class="btn btn-primary px-4 fw-bold" onclick="onModalConfirm()">
                        <i class="bi bi-check-circle me-2"></i>Đồng ý nộp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentStep = 1;

        // Toast Helper
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();
            let bgClass = 'bg-primary';
            let icon = 'bi-info-circle';

            if (type === 'success') {
                bgClass = 'bg-success';
                icon = 'bi-check-circle-fill';
            } else if (type === 'error' || type === 'danger') {
                bgClass = 'bg-danger';
                icon = 'bi-exclamation-triangle-fill';
            } else if (type === 'warning') {
                bgClass = 'bg-warning text-dark';
                icon = 'bi-exclamation-circle-fill';
            }

            const html = `
                <div id="${toastId}" class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body d-flex align-items-center">
                            <i class="bi ${icon} fs-5 me-2"></i>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;

            toastContainer.insertAdjacentHTML('beforeend', html);
            const toastEl = document.getElementById(toastId);
            const bsToast = new bootstrap.Toast(toastEl, { delay: 5000 });
            bsToast.show();
            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        // On Page Load: Fetch Land Assets for the current logged-in user (pre-filled)
        document.addEventListener('DOMContentLoaded', function () {
            const initialCccd = document.querySelector('input[name="ownerIdNumber"]').value;
            if (initialCccd) {
                fetchLandAssets(initialCccd);
            }
        });

        // NAVIGATION LOGIC
        function changeStep(n) {
            // Validate if moving to next step
            if (n > 0 && !validateStep(currentStep)) {
                return;
            }

            currentStep += n;
            if (currentStep < 1) currentStep = 1;
            if (currentStep > 4) currentStep = 4;
            updateWizardUI();
        }

        function validateStep(step) {
            const stepEl = document.getElementById(`step${step}`);
            if (!stepEl) return true;

            let isValid = true;

            // 1. Reset all validations in this step
            stepEl.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

            // 2. Specific validation for Step 2: Land Selection
            if (step === 2) {
                const landRadios = stepEl.querySelectorAll('input[name="landAsset"]');
                if (landRadios.length > 0) {
                    const checked = stepEl.querySelector('input[name="landAsset"]:checked');
                    // We need a place to show error for radio group. 
                    // For now, we'll assume the container "formLand" can show a generic alert if needed,
                    // or we check if we can add is-invalid to the container? No, radios are tricky.
                    // We'll keep the alert for "No land selected" as it's a global state for the step, 
                    // OR we can make the "A. Thông tin thửa đất" header text red?
                    if (!checked) {
                        showToast('Vui lòng chọn một thửa đất để thực hiện biến động!', 'warning');
                        return false;
                    }
                } else {
                    const warning = stepEl.querySelector('.alert-warning');
                    if (warning) {
                        showToast('Không có tài sản đất đai để thực hiện giao dịch. Vui lòng kiểm tra lại!', 'warning');
                        return false;
                    }
                }

                // Validate New Owner Auto-fill (Must have name filled)
                const newOwnerName = document.getElementById('newOwnerName');
                if (!newOwnerName.value.trim()) {
                    const cccdInput = document.getElementById('newOwnerCccd');
                    cccdInput.classList.add('is-invalid');
                    // Focus only if it's the first error
                    if (isValid) cccdInput.focus();
                    isValid = false;
                }
            }

            // 3. General Input Validation
            const inputs = stepEl.querySelectorAll('input[required], select[required], textarea[required]');
            for (let input of inputs) {
                // Check validity (HTML5)
                if (!input.checkValidity() || !input.value.trim()) {
                    input.classList.add('is-invalid');
                    if (isValid) {
                        input.focus(); // Focus first invalid
                        isValid = false;
                    }
                } else {
                    input.classList.remove('is-invalid');
                    input.classList.add('is-valid');
                }
            }

            // 4. Auth Validation (Step 1)
            if (step === 1 && document.getElementById('authToggle').checked) {
                const authCccd = document.getElementById('authorizerCccd');
                // If we have no auth data loaded (meaning we haven't successfully checked)
                // We can check if the main fields (which should have been filled by checkAuthorizer) match the authCccd?
                // Or just check if authCccd is valid.
                if (!authCccd.value.trim()) {
                    authCccd.classList.add('is-invalid');
                    if (isValid) authCccd.focus();
                    isValid = false;
                }
            }

            return isValid;
        }

        function updateWizardUI() {
            // 1. Show/Hide Content Sections
            for (let i = 1; i <= 4; i++) {
                const el = document.getElementById(`step${i}`);
                const navEl = document.getElementById(`navStep${i}`);
                if (i === currentStep) {
                    el.classList.remove('d-none');
                    navEl.classList.add('active');
                    navEl.querySelector('.btn-circle').classList.remove('text-muted');
                    navEl.querySelector('small').classList.remove('text-muted');
                    navEl.querySelector('small').classList.add('fw-bold');
                } else {
                    el.classList.add('d-none');
                    navEl.classList.remove('active');
                    if (i < currentStep) {
                        navEl.classList.add('text-success');
                    }
                }
            }

            // 2. Button State
            const btnBack = document.getElementById('btnBack');
            const btnNext = document.getElementById('btnNext');

            if (currentStep === 1) {
                btnBack.classList.add('disabled');
            } else {
                btnBack.classList.remove('disabled');
            }

            if (currentStep === 4) {
                btnNext.innerHTML = '<i class="bi bi-send-fill me-2"></i>Nộp hồ sơ';
                btnNext.classList.remove('btn-primary');
                btnNext.classList.add('btn-success');
                btnNext.onclick = function () {
                    showConfirmModal();
                };
            } else {
                btnNext.innerHTML = 'Tiếp tục <i class="bi bi-arrow-right ms-2"></i>';
                btnNext.classList.add('btn-primary');
                btnNext.classList.remove('btn-success');
                btnNext.onclick = function () { changeStep(1); };
            }
        }

        // CONFIRMATION MODAL LOGIC
        function showConfirmModal() {
            const modal = new bootstrap.Modal(document.getElementById('confirmSubmitModal'));
            modal.show();
        }

        function onModalConfirm() {
            const modalEl = document.getElementById('confirmSubmitModal');
            const modal = bootstrap.Modal.getInstance(modalEl);
            if (modal) modal.hide();
            submitDossier();
        }

        async function submitDossier() {
            const btnNext = document.getElementById('btnNext');
            const originalText = btnNext.innerHTML;
            btnNext.disabled = true;
            btnNext.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Đang xử lý...';

            try {
                const form = document.getElementById('submissionForm');
                const formData = new FormData(form);

                // FIX: Explicitly handle boolean checkbox for isAuthorized
                const authToggle = document.getElementById('authToggle');
                if (authToggle) {
                    formData.set('isAuthorized', authToggle.checked ? 'true' : 'false');
                }

                // IMPORTANT: Aggregate specific named file inputs into the 'files' parameter expected by the Controller
                const fileInputs = form.querySelectorAll('input[type="file"]');
                fileInputs.forEach(input => {
                    if (input.files.length > 0) {
                        for (let i = 0; i < input.files.length; i++) {
                            formData.append('files', input.files[i]);
                        }
                    }
                });

                const response = await fetch('/citizen/submit', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    showToast('Nộp hồ sơ thành công! Đang chuyển đến cổng thanh toán...', 'success');
                    if (result.paymentUrl) {
                        setTimeout(() => {
                            window.location.href = result.paymentUrl;
                        }, 1500);
                    } else {
                        setTimeout(() => {
                            window.location.href = '/citizen/hoso';
                        }, 2000);
                    }
                } else {
                    throw new Error(result.message || 'Có lỗi xảy ra khi nộp hồ sơ');
                }
            } catch (error) {
                console.error('Submission error:', error);
                showToast('Lỗi: ' + error.message, 'error');
                btnNext.disabled = false;
                btnNext.innerHTML = originalText;
            }
        }

        // --- AUTHORIZATION LOGIC ---
        function toggleAuthorization() {
            const isChecked = document.getElementById('authToggle').checked;
            const section = document.getElementById('authSection');
            const authFileItem = document.getElementById('authFileItem');

            if (isChecked) {
                section.classList.remove('d-none');
                if (authFileItem) authFileItem.classList.remove('d-none');
                // Auto focus for better UX
                setTimeout(() => document.getElementById('authorizerCccd').focus(), 100);
            } else {
                section.classList.add('d-none');
                if (authFileItem) authFileItem.classList.add('d-none');

                // Reset to logged-in user data
                const initialCccd = '[[${opsDossier.formData["ownerIdNumber"]}]]'; // Server-side value
                document.querySelector('input[name="currentOwner"]').value = '[[${opsDossier.formData["currentOwner"]}]]';
                document.querySelector('input[name="ownerIdNumber"]').value = initialCccd;
                document.querySelector('input[name="ownerAddress"]').value = '[[${opsDossier.formData["ownerAddress"]}]]';

                fetchLandAssets(initialCccd);
            }
        }

        async function checkAuthorizer() {
            const cccdInput = document.getElementById('authorizerCccd');
            const cccd = cccdInput.value.trim();
            const resDiv = document.getElementById('authResult');

            // Reset
            cccdInput.classList.remove('is-invalid', 'is-valid');

            if (!cccd) {
                cccdInput.classList.add('is-invalid');
                return;
            }

            resDiv.innerHTML = '<span class="text-primary"><div class="spinner-border spinner-border-sm" role="status"></div> Đang tra cứu...</span>';

            try {
                const response = await fetch(`/api/autofill/relation?targetCccd=${cccd}`);

                if (response.status === 401 || response.status === 403) {
                    showToast("Phiên đăng nhập đã hết hạn hoặc bạn chưa đăng nhập. Vui lòng đăng nhập lại!", 'warning');
                    setTimeout(() => window.location.href = '/login/citizen', 2000);
                    return;
                }

                if (response.ok) {
                    const result = await response.json();
                    if (result.valid) {
                        cccdInput.classList.add('is-valid');
                        resDiv.innerHTML = `<div class="alert alert-success py-2 mt-2 mb-0"><i class="bi bi-check-circle-fill me-2"></i>Hợp lệ: ${result.relationshipName} (${result.relationType})</div>`;
                        resDiv.classList.remove('d-none');

                        // Auto-fill Authorizer Info into Owner Fields
                        const resCitizen = await fetch(`/api/autofill/citizen/${cccd}`);
                        if (resCitizen.ok) {
                            const data = await resCitizen.json();
                            document.querySelector('input[name="currentOwner"]').value = data.fullName || '';
                            document.querySelector('input[name="ownerIdNumber"]').value = data.cccd || '';
                            document.querySelector('input[name="ownerAddress"]').value = data.permanentAddress || '';

                            // Fetch Land Assets of the Authorizer
                            fetchLandAssets(data.cccd);
                        }

                    } else {
                        cccdInput.classList.add('is-invalid');
                        if (feedback) feedback.textContent = result.message || 'Không tìm thấy mối quan hệ hộ khẩu chung.';
                        resDiv.classList.add('d-none');
                    }
                } else {
                    cccdInput.classList.add('is-invalid');
                    if (feedback) feedback.textContent = 'Lỗi tra cứu quan hệ.';
                    resDiv.classList.add('d-none');
                }
            } catch (e) {
                console.error(e);
                cccdInput.classList.add('is-invalid');
                if (feedback) feedback.textContent = 'Lỗi kết nối máy chủ.';
                resDiv.classList.add('d-none');
            }
        }

        // Global land data
        let landData = [];

        async function fetchLandAssets(cccd) {
            try {
                const resLand = await fetch(`/api/autofill/land/${cccd}`);
                const landListContainer = document.getElementById('landAssetList');
                landListContainer.innerHTML = ''; // Clear current mock data

                if (resLand.status === 204) {
                    // ... (Error handling omitted for brevity, logic remains same)
                    landListContainer.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning d-flex align-items-center mb-0" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>
                            <div>
                                Không tìm thấy dữ liệu đất đai nào liên kết với số CCCD này.
                                <br><small>Vui lòng kiểm tra lại CCCD hoặc liên hệ cán bộ địa chính.</small>
                            </div>
                        </div>
                    </div>`;
                    return;
                }

                if (resLand.ok) {
                    const lands = await resLand.json();
                    landData = lands; // Store globally

                    if (lands.length === 0) {
                        // ... (Empty handling)
                        landListContainer.innerHTML = `
                            <div class="col-12">
                                <div class="alert alert-warning text-center">
                                    Không tìm thấy tài sản đất đai nào dưới tên của bạn.
                                </div>
                            </div>`;
                        return;
                    }

                    let firstValidIndex = -1;

                    lands.forEach((land, index) => {
                        const status = land.landStatus || 'Hợp pháp';
                        const isBlocked = status !== 'Hợp pháp';

                        // Check if this is the first valid item to auto-select
                        let isChecked = '';
                        let borderClass = 'bg-light border-0';
                        let textClass = '';
                        let cursorClass = 'cursor-pointer';
                        let opacityClass = '';
                        let clickAction = `onclick="selectLand(this, ${index})"`;
                        let disabledAttr = '';

                        if (isBlocked) {
                            borderClass = 'bg-light border-secondary border-opacity-25'; // distinct look for disabled
                            cursorClass = 'cursor-not-allowed';
                            opacityClass = 'opacity-75';
                            clickAction = ''; // No click
                            disabledAttr = 'disabled';
                        } else {
                            if (firstValidIndex === -1) {
                                firstValidIndex = index;
                                isChecked = 'checked';
                                borderClass = 'border-primary shadow-sm bg-light-primary';
                                textClass = 'text-primary';
                            }
                        }

                        const html = `
                        <div class="col">
                            <label class="card h-100 ${cursorClass} ${borderClass} ${opacityClass}" ${clickAction}>
                                <div class="card-body">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="landAsset" ${isChecked} ${disabledAttr} required>
                                        <h6 class="form-check-label fw-bold ${textClass}">Thửa ${land.parcelNumber}, Tờ bản đồ ${land.mapSheetNumber}</h6>
                                    </div>
                                    <hr class="my-2 opacity-50">
                                    <ul class="small text-muted ps-0 mb-0 list-unstyled">
                                        <li class="mb-1"><i class="bi bi-geo-alt me-2"></i>${land.addressDetail || 'N/A'}</li>
                                        <li class="mb-1"><i class="bi bi-aspect-ratio me-2"></i>${land.areaM2} m² (${land.usageForm || '-'})</li>
                                        <li class="mb-1"><i class="bi bi-journal-bookmark me-2"></i>Số GCN: <strong>${land.landCertificateNumber}</strong></li>
                                        
                                        <li class="mt-2 text-dark"><i class="bi bi-bullseye me-2"></i>Mục đích: ${land.landPurpose || 'Chưa cập nhật'}</li>
                                        <li class="text-dark"><i class="bi bi-hourglass-split me-2"></i>Thời hạn: ${land.usagePeriod || 'Lâu dài'}</li>
                                        <li class="text-dark"><i class="bi bi-info-circle me-2"></i>Nguồn gốc: ${land.assetNotes || 'Công nhận QSDĐ'}</li>
                                        
                                        <li class="mt-2 pt-2 border-top text-end">
                                            Trạng thái: <span class="badge ${isBlocked ? 'bg-danger' : 'bg-success'}">${status}</span>
                                            ${isBlocked ? '<div class="text-danger small fw-bold mt-1"><i class="bi bi-slash-circle me-1"></i>Không thể giao dịch</div>' : ''}
                                        </li>
                                    </ul>
                                </div>
                            </label>
                        </div>
                    `;
                        landListContainer.insertAdjacentHTML('beforeend', html);
                    });

                    // Auto-select the first valid one
                    if (firstValidIndex !== -1) {
                        updateHiddenLandFields(firstValidIndex);
                    }
                }
            } catch (error) {
                console.error(error);
            }
        }

        function selectLand(card, index) {
            // Visual update
            document.querySelectorAll('#landAssetList .card').forEach(c => {
                c.classList.remove('border-primary', 'shadow-sm', 'bg-light-primary');
                c.classList.add('bg-light', 'border-0');
                c.querySelector('.form-check-input').checked = false;
                c.querySelector('.form-check-label').classList.remove('text-primary');
            });

            card.classList.remove('bg-light', 'border-0');
            card.classList.add('border-primary', 'shadow-sm', 'bg-light-primary');
            card.querySelector('.form-check-input').checked = true;
            card.querySelector('.form-check-label').classList.add('text-primary');

            // Update hidden fields
            updateHiddenLandFields(index);
        }

        function updateHiddenLandFields(index) {
            const land = landData[index];
            if (!land) return;

            document.querySelector('input[name="landCertificateNumber"]').value = land.landCertificateNumber || '';
            document.querySelector('input[name="landPlotNumber"]').value = land.parcelNumber || '';
            document.querySelector('input[name="landMapSheet"]').value = land.mapSheetNumber || '';
            document.querySelector('input[name="landAddress"]').value = land.addressDetail || '';
            document.querySelector('input[name="landArea"]').value = land.areaM2 || '';
            document.querySelector('input[name="landUseType"]').value = land.usageForm || '';
            document.querySelector('input[name="landPurpose"]').value = land.landPurpose || '';
        }

        // NEW OWNER AUTO-FILL LOGIC
        async function autoFillNewOwner() {
            const cccdInput = document.getElementById('newOwnerCccd');
            const cccd = cccdInput.value.trim();

            // Reset validation
            cccdInput.classList.remove('is-invalid', 'is-valid');

            if (!cccd) {
                cccdInput.classList.add('is-invalid');
                return;
            }

            try {
                const res = await fetch(`/api/autofill/citizen/${cccd}`);
                if (res.ok) {
                    const data = await res.json();

                    document.getElementById('newOwnerName').value = data.fullName;
                    document.getElementById('newOwnerAddress').value = data.permanentAddress;

                    cccdInput.classList.add('is-valid');
                } else {
                    cccdInput.classList.add('is-invalid');
                    document.getElementById('newOwnerName').value = "";
                    document.getElementById('newOwnerAddress').value = "";
                }
            } catch (e) {
                console.error(e);
                cccdInput.classList.add('is-invalid');
            }
        }


        // --- FILE HANDLING LOGIC ---
        function validateFileSize(input) {
            if (input.files && input.files.length > 0) {
                const maxSize = 20 * 1024 * 1024; // 20MB
                for (let i = 0; i < input.files.length; i++) {
                    const file = input.files[i];
                    if (file.size > maxSize) {
                        showToast(`File "${file.name}" quá lớn (Tối đa 20MB).`, 'error');
                        input.value = ''; // Reset input
                        return;
                    }
                }
            }
        }

        // Update Authorization Toggle to Show/Hide File Input
        const originalToggleAuth = toggleAuthorization;
        toggleAuthorization = function () {
            // Call original logic first (UI toggle for Step 1)
            const isChecked = document.getElementById('authToggle').checked;
            const section = document.getElementById('authSection');

            if (isChecked) {
                section.classList.remove('d-none');

                // Show Submitter Info
                document.getElementById('submitterInfoSection').classList.remove('d-none');

                // Populate Submitter Info with Logged-in User Data (Stored in initial variables)
                // We use the initial values which represent the logged-in user
                document.getElementById('submitterName').value = '[[${opsDossier.formData["currentOwner"]}]]';
                document.getElementById('submitterCccd').value = '[[${opsDossier.formData["ownerIdNumber"]}]]';
                document.getElementById('submitterAddress').value = '[[${opsDossier.formData["ownerAddress"]}]]';

                // Clear Owner Info (To be filled by lookup)
                document.querySelector('input[name="currentOwner"]').value = '';
                document.querySelector('input[name="ownerIdNumber"]').value = '';
                document.querySelector('input[name="ownerAddress"]').value = '';
                document.querySelector('input[name="ownerAddress"]').value = '';
                // document.querySelector('input[name="ownerIdNumber"]').removeAttribute('readonly'); 
                // Ensure it stays readonly
                document.querySelector('input[name="ownerIdNumber"]').setAttribute('readonly', 'readonly');
                // Unlock the search capability if needed, or rely on the lookup button logic

                setTimeout(() => document.getElementById('authorizerCccd').focus(), 100);
            } else {
                section.classList.add('d-none');

                // Hide Submitter Info
                document.getElementById('submitterInfoSection').classList.add('d-none');

                // Reset to logged-in user data into Owner fields
                const initialCccd = '[[${opsDossier.formData["ownerIdNumber"]}]]';
                document.querySelector('input[name="currentOwner"]').value = '[[${opsDossier.formData["currentOwner"]}]]';
                document.querySelector('input[name="ownerIdNumber"]').value = initialCccd;
                document.querySelector('input[name="ownerAddress"]').value = '[[${opsDossier.formData["ownerAddress"]}]]';
                document.querySelector('input[name="ownerIdNumber"]').setAttribute('readonly', 'readonly');

                fetchLandAssets(initialCccd);
            }

            // Step 3 UI Toggle
            const authFileItem = document.getElementById('authFileItem');
            const authFileInput = document.getElementById('fileUyQuyenInput');
            if (isChecked) {
                if (authFileItem) authFileItem.classList.remove('d-none');
                if (authFileInput) authFileInput.setAttribute('required', 'required');
            } else {
                if (authFileItem) authFileItem.classList.add('d-none');
                if (authFileInput) authFileInput.removeAttribute('required');
                if (authFileInput) authFileInput.value = ''; // Clear file if unchecked
            }
        }


    </script>
</body>

</html>
```